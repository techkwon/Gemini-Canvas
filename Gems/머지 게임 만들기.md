ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì£¼ì œë¥¼ ê°€ì§€ê³  ì•„ë˜ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì„œ ë¨¸ì§€ ê²Œì„ì„ ìº”ë²„ìŠ¤ì— ì™„ì„±í•©ë‹ˆë‹¤.



---



<!DOCTYPE html>

<html lang="ko">

<head>

Â  Â  <meta charset="UTF-8">

Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

Â  Â  <title>ë‹¬ë ¤ë¼! êµí†µìˆ˜ë‹¨</title>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">

Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

Â  Â  <style>

Â  Â  Â  Â  body { font-family: 'Jua', sans-serif; overflow: hidden; background-color: #e0f2fe; display: flex; align-items: center; justify-content: center; height: 100vh; }

Â  Â  Â  Â  canvas { display: block; }

Â  Â  Â  Â  .popup-enter { animation: fadeIn 0.3s ease-out; }

Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

Â  Â  Â  Â  .blinking { animation: blink 1.5s infinite; }

Â  Â  Â  Â  @keyframes blink { 50% { opacity: 0.5; } }

Â  Â  </style>

</head>

<body class="p-2 sm:p-4">

Â  Â Â 

Â  Â  <div class="w-full max-w-sm mx-auto h-full max-h-[95vh] sm:max-h-[800px] flex flex-col">

Â  Â  Â  Â  <div class="w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col flex-grow min-h-0">

Â  Â  Â  Â  Â  Â  <header class="p-3 sm:p-4 bg-sky-500 text-white text-center rounded-t-3xl flex-shrink-0">

Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl sm:text-3xl font-bold">ë‹¬ë ¤ë¼! êµí†µìˆ˜ë‹¨</h1>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mt-1 sm:mt-2 text-sm sm:text-lg">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>ìµœê³ ì ìˆ˜: <span id="high-score">0</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>í˜„ì¬ì ìˆ˜: <span id="current-score">0</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </header>

Â  Â  Â  Â  Â  Â  <div class="bg-sky-200 p-2 flex items-center justify-center space-x-4 flex-shrink-0">

Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-slate-700">ë‹¤ìŒ êµí†µìˆ˜ë‹¨:</span>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="next-vehicle-display" class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-white rounded-full shadow-inner">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="next-vehicle-emoji" class="text-2xl sm:text-3xl"></span>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="game-container" class="relative flex-grow min-h-0">

Â  Â  Â  Â  Â  Â  Â  Â  <div id="game-over-modal" class="hidden absolute inset-0 bg-black bg-opacity-60 flex-col items-center justify-center text-center p-8 z-50 popup-enter">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- ê²Œì„ ì˜¤ë²„ ë‚´ìš©ì€ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â Â 

Â  Â  <!-- íŒì—…ë“¤ -->

Â  Â  <div id="discovery-popup" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[100] popup-enter">

Â  Â  Â  Â  <div class="bg-gradient-to-br from-yellow-200 to-amber-300 rounded-3xl p-6 text-center shadow-2xl max-w-sm w-full border-4 border-white">

Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-amber-700 mb-2">âœ¨ êµí†µìˆ˜ë‹¨ í•´ê¸ˆ! âœ¨</h2>

Â  Â  Â  Â  Â  Â  <div id="popup-emoji" class="text-8xl my-4 animate-bounce"></div>

Â  Â  Â  Â  Â  Â  <h3 id="popup-name" class="text-4xl font-bold text-slate-800"></h3>

Â  Â  Â  Â  Â  Â  <p id="popup-description" class="text-slate-600 mt-2 mb-6 text-lg"></p>

Â  Â  Â  Â  Â  Â  <button id="popup-close-button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg">ê³„ì†í•˜ê¸°</button>

Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <div id="game-complete-popup" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[100] popup-enter">

Â  Â  Â  Â  <div class="bg-gradient-to-br from-blue-300 to-indigo-400 rounded-3xl p-6 text-center shadow-2xl max-w-sm w-full border-4 border-white">

Â  Â  Â  Â  Â  Â  <h2 class="text-4xl font-bold text-white mb-2">ğŸ‰ ë„ê° ì™„ì„±! ğŸ‰</h2>

Â  Â  Â  Â  Â  Â  <div class="text-8xl my-4 animate-bounce">ğŸ›¸</div>

Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-white">ëª¨ë“  êµí†µìˆ˜ë‹¨ì„ ì™„ì„±í–ˆì–´ìš”!</h3>

Â  Â  Â  Â  Â  Â  <p class="text-white mt-2 mb-6 text-lg">ë‹¹ì‹ ì€ ìµœê³ ì˜ êµí†µìˆ˜ë‹¨ ë§ˆìŠ¤í„°ì…ë‹ˆë‹¤!</p>

Â  Â  Â  Â  Â  Â  <button id="complete-popup-close-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg">ê³„ì† ë„ì „í•˜ê¸°</button>

Â  Â  Â  Â  </div>

Â  Â  </div>



Â  Â  <script type="module">

Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

Â  Â  Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

Â  Â  Â  Â  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



Â  Â  Â  Â  const { Engine, Render, Runner, World, Bodies, Common, Events, Body, Composite } = Matter;



Â  Â  Â  Â  // Firebase ì„¤ì •

Â  Â  Â  Â  let db, auth;

Â  Â  Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

Â  Â  Â  Â Â 

Â  Â  Â  Â  async function setupFirebase() {

Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  const firebaseConfig = JSON.parse(__firebase_config);

Â  Â  Â  Â  Â  Â  Â  Â  const app = initializeApp(firebaseConfig);

Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(app);

Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(app);

Â  Â  Â  Â  Â  Â  Â  Â  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInWithCustomToken(auth, __initial_auth_token);

Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  console.log("Firebase initialized and user signed in.");

Â  Â  Â  Â  Â  Â  Â  Â  init(); // Firebase ì„¤ì • í›„ ê²Œì„ ì‹œì‘

Â  Â  Â  Â  Â  Â  } catch (error) {

Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);

Â  Â  Â  Â  Â  Â  Â  Â  // Firebase ì—†ì´ë„ ê²Œì„ì´ ì‹¤í–‰ë˜ë„ë¡ init() í˜¸ì¶œ

Â  Â  Â  Â  Â  Â  Â  Â  init();

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }





Â  Â  Â  Â  // --- ë‚˜ë¨¸ì§€ ê²Œì„ ì½”ë“œ ---

Â  Â  Â  Â  const gameContainer = document.getElementById('game-container');

Â  Â  Â  Â  let containerWidth, containerHeight;

Â  Â  Â  Â Â 

Â  Â  Â  Â  const highScoreEl = document.getElementById('high-score');

Â  Â  Â  Â  const currentScoreEl = document.getElementById('current-score');

Â  Â  Â  Â  const nextVehicleEmojiEl = document.getElementById('next-vehicle-emoji');

Â  Â  Â  Â Â 

Â  Â  Â  Â  const gameOverModal = document.getElementById('game-over-modal');

Â  Â  Â  Â  const discoveryPopup = document.getElementById('discovery-popup');

Â  Â  Â  Â  const popupEmoji = document.getElementById('popup-emoji');

Â  Â  Â  Â  const popupName = document.getElementById('popup-name');

Â  Â  Â  Â  const popupDescription = document.getElementById('popup-description');

Â  Â  Â  Â  const popupCloseButton = document.getElementById('popup-close-button');

Â  Â  Â  Â  const gameCompletePopup = document.getElementById('game-complete-popup');

Â  Â  Â  Â  const completePopupCloseButton = document.getElementById('complete-popup-close-button');



Â  Â  Â  Â  let VEHICLES;

Â  Â  Â  Â  const MAX_LEVEL = 9;

Â  Â  Â  Â  const MAX_SPAWN_LEVEL = 4;



Â  Â  Â  Â  let engine, render, runner;

Â  Â  Â  Â  let currentScore = 0;

Â  Â  Â  Â  let highScore = localStorage.getItem('transportation-highscore') || 0;

Â  Â  Â  Â  let discoveredVehicles = JSON.parse(localStorage.getItem('discoveredVehicles')) || [0];

Â  Â  Â  Â  let isGameOver = false;

Â  Â  Â  Â  let currentVehicle = null;

Â  Â  Â  Â  let nextVehicleInfo = null;

Â  Â  Â  Â  let disableAction = false;

Â  Â  Â  Â  let isAudioStarted = false;

Â  Â  Â  Â  let isFirstVehicle = true;

Â  Â  Â  Â Â 

Â  Â  Â  Â  let bodiesToRemove = new Set();

Â  Â  Â  Â  let bodiesToAdd = [];



Â  Â  Â  Â  // ì‚¬ìš´ë“œ ì„¤ì •

Â  Â  Â  Â  const bgmSynth = new Tone.FMSynth({ harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 }, modulation: { type: "sawtooth" }, modulationEnvelope: { attack: 0.1, decay: 0.1, sustain: 0.5, release: 0.1 } }).toDestination();

Â  Â  Â  Â  bgmSynth.volume.value = -15;

Â  Â  Â  Â  const bgmPattern = new Tone.Sequence((time, note) => { bgmSynth.triggerAttackRelease(note, "16n", time); }, ['C2', 'G2', 'C3', 'G2', 'C2', 'D#2', 'C2', 'D#2']).start(0);

Â  Â  Â  Â  bgmPattern.loop = true;

Â  Â  Â  Â  const melodySynth = new Tone.AMSynth({ envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 } }).toDestination();

Â  Â  Â  Â  melodySynth.volume.value = -10;

Â  Â  Â  Â  const melodyPattern = new Tone.Sequence((time, note) => { melodySynth.triggerAttackRelease(note, '8n', time); }, ['G4', 'A#4', 'C5', 'A#4', null, 'G4', 'F4', 'G4']).start("0:2");

Â  Â  Â  Â  melodyPattern.loop = true;

Â  Â  Â  Â  Tone.Transport.bpm.value = 140;

Â  Â  Â  Â  const sfxSynth = new Tone.PolySynth(Tone.Synth).toDestination();

Â  Â  Â  Â  const dropSound = () => sfxSynth.triggerAttackRelease("C4", "8n");

Â  Â  Â  Â  const mergeSound = (level) => sfxSynth.triggerAttackRelease(440 * Math.pow(2, (level - 4) / 12), "8n");

Â  Â  Â  Â  const discoverySound = () => { const now = Tone.now(); sfxSynth.triggerAttackRelease("C5", "8n", now); sfxSynth.triggerAttackRelease("E5", "8n", now + 0.1); sfxSynth.triggerAttackRelease("G5", "8n", now + 0.2); };

Â  Â  Â  Â  const completeSound = () => { const now = Tone.now(); sfxSynth.triggerAttackRelease("C5", "8n", now); sfxSynth.triggerAttackRelease("G5", "8n", now + 0.2); sfxSynth.triggerAttackRelease("C6", "8n", now + 0.4); };

Â  Â  Â  Â  const gameOverSound = () => { const now = Tone.now(); sfxSynth.triggerAttackRelease("C4", "8n", now); sfxSynth.triggerAttackRelease("G3", "8n", now + 0.2); sfxSynth.triggerAttackRelease("E3", "8n", now + 0.4); };



Â  Â  Â  Â  function showDiscoveryPopup(level) {

Â  Â  Â  Â  Â  Â  const vehicle = VEHICLES[level];

Â  Â  Â  Â  Â  Â  if (!vehicle) return;

Â  Â  Â  Â  Â  Â  disableAction = true; Runner.stop(runner); if (isAudioStarted) Tone.Transport.pause();

Â  Â  Â  Â  Â  Â  popupEmoji.textContent = vehicle.emoji; popupName.textContent = vehicle.name; popupDescription.textContent = vehicle.description;

Â  Â  Â  Â  Â  Â  discoveryPopup.classList.remove('hidden'); discoverySound();

Â  Â  Â  Â  }

Â  Â  Â  Â  function showGameCompletePopup() {

Â  Â  Â  Â  Â  Â  disableAction = true; Runner.stop(runner); if (isAudioStarted) Tone.Transport.pause();

Â  Â  Â  Â  Â  Â  gameCompletePopup.classList.remove('hidden'); completeSound();

Â  Â  Â  Â  }

Â  Â  Â  Â  popupCloseButton.addEventListener('click', () => {

Â  Â  Â  Â  Â  Â  discoveryPopup.classList.add('hidden'); Runner.run(runner, engine); if (isAudioStarted) Tone.Transport.start();

Â  Â  Â  Â  Â  Â  setTimeout(() => { if (!isGameOver) { spawnCurrentVehicle(); disableAction = false; } }, 100);Â 

Â  Â  Â  Â  });

Â  Â  Â  Â  completePopupCloseButton.addEventListener('click', () => {

Â  Â  Â  Â  Â  Â  Â gameCompletePopup.classList.add('hidden'); Runner.run(runner, engine); if (isAudioStarted) Tone.Transport.start();

Â  Â  Â  Â  Â  Â  Â setTimeout(() => { if (!isGameOver) { spawnCurrentVehicle(); disableAction = false; } }, 100);

Â  Â  Â  Â  });



Â  Â  Â  Â  function init() {

Â  Â  Â  Â  Â  Â  containerWidth = gameContainer.clientWidth; containerHeight = gameContainer.clientHeight;

Â  Â  Â  Â  Â  Â  VEHICLES = [ { level: 0, name: 'ìì „ê±°', radius: containerWidth * 0.05, score: 1, emoji: 'ğŸš²', color: '#ffc9c9', description: 'ë‘ ë°”í€´ë¡œ ì”½ì”½! í˜ë‹¬ì„ ë°Ÿì•„ ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ëŠ” ë©‹ì§„ ì¹œêµ¬ì˜ˆìš”.' }, { level: 1, name: 'ì˜¤í† ë°”ì´', radius: containerWidth * 0.065, score: 3, emoji: 'ğŸ›µ', color: '#fcc2d7', description: 'ë¶€ë¦‰ë¶€ë¦‰! ì—”ì§„ì˜ í˜ìœ¼ë¡œ ìì „ê±°ë³´ë‹¤ í›¨ì”¬ ë¹ ë¥´ê²Œ ë‹¬ë¦´ ìˆ˜ ìˆì–´ìš”.' }, { level: 2, name: 'ìë™ì°¨', radius: containerWidth * 0.08, score: 6, emoji: 'ğŸš—', color: '#eebefa', description: 'ë„¤ ê°œì˜ ë°”í€´ë¡œ ì•ˆì •ì ì´ê³  í¸ì•ˆí•˜ê²Œ ìš°ë¦¬ë¥¼ íƒœì›Œì¤˜ìš”.' }, { level: 3, name: 'ë²„ìŠ¤', radius: containerWidth * 0.10, score: 10, emoji: 'ğŸšŒ', color: '#d0bfff', description: 'ë§ì€ ì‚¬ëŒë“¤ì„ í•œ ë²ˆì— íƒœìš°ê³  ì •í•´ì§„ ê¸¸ì„ ë”°ë¼ ë‹¬ë ¤ìš”.' }, { level: 4, name: 'íŠ¸ëŸ­', radius: containerWidth * 0.12, score: 15, emoji: 'ğŸšš', color: '#bac8ff', description: 'í¬ê³  ë¬´ê±°ìš´ ì§ì„ ì‹¤ì–´ ë©€ë¦¬ê¹Œì§€ ì•ˆì „í•˜ê²Œ ì˜®ê²¨ì¤€ë‹µë‹ˆë‹¤.' }, { level: 5, name: 'ê¸°ì°¨', radius: containerWidth * 0.15, score: 21, emoji: 'ğŸš‚', color: '#a3d8ff', description: 'ì¹™ì¹™í­í­! ê¸¸ê³  ê¸´ ëª¸ìœ¼ë¡œ ì•„ì£¼ ë§ì€ ì‚¬ëŒê³¼ ì§ì„ ì‹£ê³  ë‹¬ë ¤ìš”.' }, { level: 6, name: 'ë°°', radius: containerWidth * 0.18, score: 28, emoji: 'ğŸš¢', color: '#99e9f2', description: 'ë„“ì€ ë°”ë‹¤ ìœ„ë¥¼ ë– ë‹¤ë‹ˆë©° ë‹¤ë¥¸ ë‚˜ë¼ë¡œ ì—¬í–‰ì„ ë– ë‚  ìˆ˜ ìˆì–´ìš”.' }, { level: 7, name: 'ë¹„í–‰ê¸°', radius: containerWidth * 0.22, score: 36, emoji: 'âœˆï¸', color: '#96f2d7', description: 'ì»¤ë‹¤ë€ ë‚ ê°œë¡œ í•˜ëŠ˜ì„ ë‚ ì•„ êµ¬ë¦„ë³´ë‹¤ ë†’ì´ ì˜¬ë¼ê°ˆ ìˆ˜ ìˆì–´ìš”.' }, { level: 8, name: 'ë¡œì¼“', radius: containerWidth * 0.28, score: 45, emoji: 'ğŸš€', color: '#b2f2bb', description: 'ê°•ë ¥í•œ ë¶ˆê½ƒì„ ë‚´ë¿œìœ¼ë©° ì§€êµ¬ë¥¼ ë²—ì–´ë‚˜ ìš°ì£¼ë¡œ ë‚ ì•„ì˜¬ë¼ìš”!' }, { level: 9, name: 'ìš°ì£¼ì„ ', radius: containerWidth * 0.34, score: 55, emoji: 'ğŸ›¸', color: '#ffec99', description: 'ë°˜ì§ë°˜ì§ ìµœì¢… ë‹¨ê³„! ë¯¸ì§€ì˜ ìš°ì£¼ë¥¼ íƒí—˜í•˜ëŠ” ì‹ ë¹„í•œ ë¹„í–‰ì²´ì˜ˆìš”.' } ];

Â  Â  Â  Â  Â  Â  if (engine) World.clear(engine.world, false); if (render) Render.stop(render); if (runner) Runner.stop(runner); if (render && render.canvas) render.canvas.remove();

Â  Â  Â  Â  Â  Â  bodiesToRemove.clear(); bodiesToAdd = []; isFirstVehicle = true;

Â  Â  Â  Â  Â  Â  engine = Engine.create(); engine.world.gravity.y = 1;

Â  Â  Â  Â  Â  Â  render = Render.create({ element: gameContainer, engine: engine, options: { width: containerWidth, height: containerHeight, wireframes: false, background: 'transparent' } });

Â  Â  Â  Â  Â  Â  runner = Runner.create(); Runner.run(runner, engine); Render.run(render, engine);

Â  Â  Â  Â  Â  Â  currentScore = 0; isGameOver = false; disableAction = false; updateScores(); gameOverModal.classList.add('hidden');

Â  Â  Â  Â  Â  Â  createBoundaries(); prepareNextVehicle(); spawnCurrentVehicle(); setupEventListeners();

Â  Â  Â  Â  Â  Â  if (isAudioStarted) Tone.Transport.start();

Â  Â  Â  Â  }

Â  Â  Â  Â  function createBoundaries() {

Â  Â  Â  Â  Â  Â  const wallOptions = { isStatic: true, render: { fillStyle: '#60a5fa' } };

Â  Â  Â  Â  Â  Â  World.add(engine.world, [ Bodies.rectangle(containerWidth / 2, containerHeight, containerWidth, 50, wallOptions), Bodies.rectangle(10, containerHeight / 2, 20, containerHeight, wallOptions), Bodies.rectangle(containerWidth - 10, containerHeight / 2, 20, containerHeight, wallOptions) ]);

Â  Â  Â  Â  }

Â  Â  Â  Â  function addVehicle(x, y, level) {

Â  Â  Â  Â  Â  Â  if (level > MAX_LEVEL) return null;

Â  Â  Â  Â  Â  Â  const vehicleInfo = VEHICLES[level];

Â  Â  Â  Â  Â  Â  const vehicle = Bodies.circle(x, y, vehicleInfo.radius, { label: `vehicle_${level}`, restitution: 0.3, friction: 0.5, render: { fillStyle: vehicleInfo.color } });

Â  Â  Â  Â  Â  Â  if (!discoveredVehicles.includes(level)) {

Â  Â  Â  Â  Â  Â  Â  Â  discoveredVehicles.push(level); localStorage.setItem('discoveredVehicles', JSON.stringify(discoveredVehicles));

Â  Â  Â  Â  Â  Â  Â  Â  if (level === MAX_LEVEL) { showGameCompletePopup(); } else { showDiscoveryPopup(level); }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  World.add(engine.world, vehicle); return vehicle;

Â  Â  Â  Â  }

Â  Â  Â  Â  function prepareNextVehicle() {

Â  Â  Â  Â  Â  Â  let spawnableLevels = discoveredVehicles.filter(level => level <= MAX_SPAWN_LEVEL); if (spawnableLevels.length === 0) spawnableLevels = [0];

Â  Â  Â  Â  Â  Â  const randomLevel = isFirstVehicle ? 0 : spawnableLevels[Math.floor(Math.random() * spawnableLevels.length)];

Â  Â  Â  Â  Â  Â  nextVehicleInfo = VEHICLES[randomLevel]; nextVehicleEmojiEl.textContent = nextVehicleInfo.emoji; nextVehicleEmojiEl.style.fontSize = `${containerWidth * 0.05 * 1.5}px`;

Â  Â  Â  Â  }

Â  Â  Â  Â  function spawnCurrentVehicle() {

Â  Â  Â  Â  Â  Â  if (isGameOver || currentVehicle) return;Â 

Â  Â  Â  Â  Â  Â  currentVehicle = addVehicle(containerWidth / 2, 50, nextVehicleInfo.level); if(currentVehicle) Body.setStatic(currentVehicle, true); prepareNextVehicle();

Â  Â  Â  Â  }

Â  Â  Â  Â  function setupEventListeners() {

Â  Â  Â  Â  Â  Â  const handleMove = (e) => {

Â  Â  Â  Â  Â  Â  Â  Â  if (!currentVehicle || isGameOver || disableAction) return; e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  let x = e.offsetX; if (e.touches) x = e.touches[0].clientX - gameContainer.getBoundingClientRect().left;

Â  Â  Â  Â  Â  Â  Â  Â  const radius = VEHICLES[parseInt(currentVehicle.label.split('_')[1])].radius; const clampedX = Common.clamp(x, radius + 10, containerWidth - radius - 10);

Â  Â  Â  Â  Â  Â  Â  Â  Body.setPosition(currentVehicle, { x: clampedX, y: currentVehicle.position.y });

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const handleDrop = async () => {

Â  Â  Â  Â  Â  Â  Â  Â  if (!currentVehicle || isGameOver || disableAction) return;

Â  Â  Â  Â  Â  Â  Â  Â  if (!isAudioStarted) { await Tone.start(); Tone.Transport.start(); isAudioStarted = true; }

Â  Â  Â  Â  Â  Â  Â  Â  Body.setStatic(currentVehicle, false); dropSound(); if (isFirstVehicle) isFirstVehicle = false;

Â  Â  Â  Â  Â  Â  Â  Â  disableAction = true; currentVehicle = null;

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { if (discoveryPopup.classList.contains('hidden') && gameCompletePopup.classList.contains('hidden')) { spawnCurrentVehicle(); disableAction = false; } }, 800);

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  gameContainer.addEventListener('mousemove', handleMove); gameContainer.addEventListener('touchmove', handleMove, { passive: false }); gameContainer.addEventListener('mousedown', handleDrop); gameContainer.addEventListener('touchend', handleDrop);

Â  Â  Â  Â  Â  Â  Events.on(engine, 'collisionStart', handleCollision); Events.on(engine, 'afterUpdate', processDeferredActions); Events.on(render, 'afterRender', afterRender);

Â  Â  Â  Â  }

Â  Â  Â  Â  function processDeferredActions() {

Â  Â  Â  Â  Â  Â  if(isGameOver) return;

Â  Â  Â  Â  Â  Â  if (bodiesToRemove.size > 0) { bodiesToRemove.forEach(body => World.remove(engine.world, body)); bodiesToRemove.clear(); }

Â  Â  Â  Â  Â  Â  if (bodiesToAdd.length > 0) { bodiesToAdd.forEach(data => addVehicle(data.x, data.y, data.level)); bodiesToAdd = []; }

Â  Â  Â  Â  }

Â  Â  Â  Â  let gameOverCheckTimeout = null;

Â  Â  Â  Â  function afterRender() {

Â  Â  Â  Â  Â  Â  const bodies = Composite.allBodies(engine.world); const context = render.context; let isAboveLine = false;

Â  Â  Â  Â  Â  Â  bodies.forEach(body => {

Â  Â  Â  Â  Â  Â  Â  Â  if (body.label && body.label.startsWith('vehicle_')) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const level = parseInt(body.label.split('_')[1]); const vehicleInfo = VEHICLES[level];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  context.font = `${vehicleInfo.radius * 1.5}px Jua`; context.textAlign = "center"; context.textBaseline = "middle"; context.fillStyle = '#000000'; context.fillText(vehicleInfo.emoji, body.position.x, body.position.y);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!body.isStatic && body.position.y - body.circleRadius < 100) { isAboveLine = true; }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  context.beginPath(); context.moveTo(0, 100); context.lineTo(containerWidth, 100); context.strokeStyle = 'rgba(255, 0, 0, 0.5)'; context.lineWidth = 2; context.setLineDash([5, 5]); context.stroke(); context.setLineDash([]);

Â  Â  Â  Â  Â  Â  if (isAboveLine && !isGameOver) {

Â  Â  Â  Â  Â  Â  Â  Â  if (!gameOverCheckTimeout) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameOverCheckTimeout = setTimeout(() => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const bodiesNow = Composite.allBodies(engine.world); let stillAbove = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â bodiesNow.forEach(body => { if (body.label && body.label.startsWith('vehicle_') && !body.isStatic && body.position.y - body.circleRadius < 100) { stillAbove = true; } });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (stillAbove) triggerGameOver();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameOverCheckTimeout = null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } else if (!isAboveLine && gameOverCheckTimeout) { clearTimeout(gameOverCheckTimeout); gameOverCheckTimeout = null; }

Â  Â  Â  Â  }

Â  Â  Â  Â  function handleCollision(event) {

Â  Â  Â  Â  Â  Â  if (isGameOver) return; const pairs = event.pairs;

Â  Â  Â  Â  Â  Â  for (const pair of pairs) {

Â  Â  Â  Â  Â  Â  Â  Â  const { bodyA, bodyB } = pair;

Â  Â  Â  Â  Â  Â  Â  Â  Â if (!bodyA.label || !bodyB.label || bodiesToRemove.has(bodyA) || bodiesToRemove.has(bodyB)) continue;

Â  Â  Â  Â  Â  Â  Â  Â  if (bodyA.label === bodyB.label && bodyA.label.startsWith('vehicle_')) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const level = parseInt(bodyA.label.split('_')[1]); if (level >= MAX_LEVEL) continue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bodiesToRemove.add(bodyA); bodiesToRemove.add(bodyB);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bodiesToAdd.push({ x: (bodyA.position.x + bodyB.position.x) / 2, y: (bodyA.position.y + bodyB.position.y) / 2, level: level + 1 });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentScore += VEHICLES[level].score; updateScores(); mergeSound(level + 1);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  async function triggerGameOver() {

Â  Â  Â  Â  Â  Â  if(isGameOver) return; isGameOver = true;

Â  Â  Â  Â  Â  Â  Runner.stop(runner); gameOverSound(); if (isAudioStarted) Tone.Transport.stop();

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  if (!db) {

Â  Â  Â  Â  Â  Â  Â  Â  showSimpleGameOver();

Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  const leaderboardRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);

Â  Â  Â  Â  Â  Â  const q = query(leaderboardRef, orderBy("score", "desc"), limit(10));

Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  let leaderboard = [];

Â  Â  Â  Â  Â  Â  querySnapshot.forEach((doc) => {

Â  Â  Â  Â  Â  Â  Â  Â  leaderboard.push({ id: doc.id, ...doc.data() });

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  const isTopTen = leaderboard.length < 10 || currentScore > leaderboard[leaderboard.length - 1].score;



Â  Â  Â  Â  Â  Â  if (isTopTen) {

Â  Â  Â  Â  Â  Â  Â  Â  showNameInput(leaderboard);

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  showLeaderboard(leaderboard);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }



Â  Â  Â  Â  function showSimpleGameOver() {

Â  Â  Â  Â  Â  Â  Â gameOverModal.innerHTML = `<h2 class="text-5xl font-bold text-red-500 mb-4">ê²Œì„ ì¢…ë£Œ!</h2><p class="text-2xl text-white mb-2">ìµœì¢… ì ìˆ˜</p><p class="text-6xl font-bold text-yellow-300 mb-8">${currentScore}</p><button id="restart-button-simple" class="bg-yellow-400 hover:bg-yellow-500 text-slate-800 font-bold py-3 px-8 rounded-full text-2xl shadow-lg">ë‹¤ì‹œ í•˜ê¸°</button>`;

Â  Â  Â  Â  Â  Â  Â gameOverModal.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â document.getElementById('restart-button-simple').addEventListener('click', init);

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function showNameInput(leaderboard) {

Â  Â  Â  Â  Â  Â  gameOverModal.innerHTML = `

Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-4xl font-bold text-yellow-300 mb-2 blinking">ğŸ‰ TOP 10 ë‹¬ì„±! ğŸ‰</h2>

Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl text-white mb-4">ë­í‚¹ì— ì´ë¦„ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>

Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-5xl font-bold text-white mb-6">${currentScore}ì </p>

Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name-input" placeholder="ì´ë¦„ (ìµœëŒ€ 10ì)" maxlength="10" class="text-center text-xl p-2 rounded-md w-full mb-4 text-slate-800">

Â  Â  Â  Â  Â  Â  Â  Â  <button id="submit-score-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl shadow-lg">ë“±ë¡í•˜ê¸°</button>

Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  gameOverModal.classList.remove('hidden');

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const nameInput = document.getElementById('name-input');

Â  Â  Â  Â  Â  Â  document.getElementById('submit-score-button').addEventListener('click', async () => {

Â  Â  Â  Â  Â  Â  Â  Â  const name = nameInput.value.trim() || "ì´ë¦„ì—†ìŒ";

Â  Â  Â  Â  Â  Â  Â  Â  await saveScoreToLeaderboard(name, currentScore, leaderboard);

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  }



Â  Â  Â  Â  async function saveScoreToLeaderboard(name, score, leaderboard) {

Â  Â  Â  Â  Â  Â  const leaderboardRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);

Â  Â  Â  Â  Â  Â  await addDoc(leaderboardRef, { name, score, createdAt: new Date() });



Â  Â  Â  Â  Â  Â  if (leaderboard.length >= 10) {

Â  Â  Â  Â  Â  Â  Â  Â  const lowestScoreDocId = leaderboard[leaderboard.length - 1].id;

Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, `artifacts/${appId}/public/data/leaderboard`, lowestScoreDocId));

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const updatedQuerySnapshot = await getDocs(query(leaderboardRef, orderBy("score", "desc"), limit(10)));

Â  Â  Â  Â  Â  Â  const updatedLeaderboard = [];

Â  Â  Â  Â  Â  Â  updatedQuerySnapshot.forEach((doc) => {

Â  Â  Â  Â  Â  Â  Â  Â  updatedLeaderboard.push({ id: doc.id, ...doc.data() });

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  showLeaderboard(updatedLeaderboard, auth.currentUser.uid + score); // í˜„ì¬ í”Œë ˆì´ì–´ ê°•ì¡°ë¥¼ ìœ„í•œ ì„ì‹œ ID

Â  Â  Â  Â  }



Â  Â  Â  Â  function showLeaderboard(leaderboard, highlightId = null) {

Â  Â  Â  Â  Â  Â  let leaderboardHtml = `<h2 class="text-4xl font-bold text-yellow-300 mb-4">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ ğŸ†</h2><div class="w-full text-left space-y-2 mb-6">`;

Â  Â  Â  Â  Â  Â  leaderboard.forEach((entry, index) => {

Â  Â  Â  Â  Â  Â  Â  Â  const isHighlight = highlightId && entry.id === highlightId;

Â  Â  Â  Â  Â  Â  Â  Â  leaderboardHtml += `

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-2 rounded-md ${isHighlight ? 'bg-yellow-400 text-slate-800' : 'bg-white/20 text-white'}">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-lg">${index + 1}. ${entry.name}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-lg">${entry.score}ì </span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  leaderboardHtml += `</div><button id="restart-button-leaderboard" class="bg-yellow-400 hover:bg-yellow-500 text-slate-800 font-bold py-3 px-8 rounded-full text-2xl shadow-lg">ë‹¤ì‹œ í•˜ê¸°</button>`;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  gameOverModal.innerHTML = leaderboardHtml;

Â  Â  Â  Â  Â  Â  gameOverModal.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  document.getElementById('restart-button-leaderboard').addEventListener('click', init);

Â  Â  Â  Â  }



Â  Â  Â  Â  function updateScores() {

Â  Â  Â  Â  Â  Â  currentScoreEl.textContent = currentScore;

Â  Â  Â  Â  Â  Â  if (currentScore > highScore) {

Â  Â  Â  Â  Â  Â  Â  Â  highScore = currentScore; localStorage.setItem('transportation-highscore', highScore);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  highScoreEl.textContent = highScore;

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  window.addEventListener('resize', () => { clearTimeout(window.resizeTimeout); window.resizeTimeout = setTimeout(init, 250); });

Â  Â  Â  Â Â 

Â  Â  Â  Â  // Firebase ì„¤ì •ìœ¼ë¡œ ê²Œì„ ì‹œì‘

Â  Â  Â  Â  setupFirebase();

Â  Â  </script>

</body>

</html>
