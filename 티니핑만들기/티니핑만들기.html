<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºì¹˜! í‹°ë‹ˆí•‘ ìºë¦­í„° ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            /* Reverted to the previous pastel gradient background */
            background: linear-gradient(135deg, #fbc2eb, #a6c1ee, #f6d365, #fda085);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: #4A5568; 
            overflow-x: hidden;
            overflow-y: auto;
            cursor: none; 
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            margin: 1.5rem auto; /* Reduced margin for smaller screens */
            padding: 1.5rem; /* Reduced padding */
            background-color: rgba(255, 255, 255, 0.98); /* Slightly more opaque */
            border-radius: 1.5rem; 
            box-shadow: 0 15px 35px rgba(255, 105, 180, 0.2); /* Pinkish shadow */
            position: relative;
            z-index: 10;
        }
        .section-card {
            background-color: #fff;
            border: 1px solid #ffc2d1; /* More pink border */
            border-radius: 1rem; 
            padding: 1.25rem; /* Adjusted padding */
            margin-bottom: 1.25rem; /* Adjusted margin */
            box-shadow: 0 6px 12px rgba(255, 105, 180, 0.1); /* Softer pink shadow */
            opacity: 0;
            transform: translateY(25px) scale(0.95);
            animation: fadeInSlideUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes fadeInSlideUp {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .btn {
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 3px 6px rgba(222, 70, 130, 0.15); /* Pinkish shadow */
            font-weight: 600;
            border-radius: 0.75rem; 
        }
        .btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 5px 10px rgba(222, 70, 130, 0.25); /* Enhanced pink shadow on hover */
        }
        .btn:active {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 2px 4px rgba(222, 70, 130, 0.2);
        }
        
        .btn-primary {
            background-color: #ff8fab; 
            color: white;
        }
        .btn-primary:hover {
            background-color: #fb6f92; 
        }
        
        /* Used for multi-choice buttons like gender, hair, etc. */
        .choice-btn {
            background-color: #fff0f5; /* Lavender Blush - very light pink */
            color: #c75d86; /* Darker pink text */
            border: 2px solid #ffc2d1; /* Light pink border */
        }
        .choice-btn:hover {
            background-color: #ffe4e1; /* Misty Rose - slightly darker light pink */
            border-color: #ffb3c1; /* Medium light pink border */
        }
        .choice-btn.selected {
            background-color: #ff8fab !important; /* Stronger Pink */
            color: white !important;
            border: 2px solid #fb6f92 !important; /* Darker Pink border */
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.4) !important;
            transform: scale(1.05);
        }

        .result-card {
            background-color: rgba(255, 240, 245, 0.97); /* LavenderBlush, slightly more opaque */
            color: #8c435f; /* Darker, muted pink for text */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem; /* Adjusted margin */
            border: 3px solid #ffb3c1; /* Medium Light Pink border */
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.25); /* Pink shadow */
        }
        .result-image {
            border: 6px solid #ffb3c1; /* Medium Light Pink border */
            border-radius: 1rem;
            max-width: 100%;
            min-height: 200px; /* Keep min-height */
            max-height: 350px; /* Add max-height */
            object-fit: contain; /* Ensure image fits well */
            height: auto;
            margin: 1.5rem auto;
            display: block;
            background-color: #fff9fb; 
            box-shadow: 0 5px 15px rgba(222, 70, 130,0.15); /* Pinkish shadow */
        }
        .loading-spinner {
            border: 6px solid rgba(255, 175, 204, 0.3); 
            border-radius: 50%;
            border-top: 6px solid #ff8fab; 
            width: 50px; /* Slightly smaller */
            height: 50px; /* Slightly smaller */
            animation: spin 0.8s linear infinite;
            margin: 20px auto; /* Adjusted margin */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #background-elements-container { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden; 
        }
        .background-element { 
            position: absolute;
            font-size: 20px; 
            animation: float 20s infinite ease-in-out;
        }
        @keyframes float { 
            0% { transform: translateY(0px) translateX(0px) scale(1) rotate(0deg); opacity: 0.2; } /* Start more transparent */
            25% { transform: translateY(-25px) translateX(20px) scale(1.1) rotate(60deg); opacity: 0.6;}
            50% { transform: translateY(15px) translateX(-15px) scale(0.9) rotate(120deg); opacity: 0.4;}
            75% { transform: translateY(-20px) translateX(-25px) scale(1.05) rotate(180deg); opacity: 0.5;}
            100% { transform: translateY(0px) translateX(0px) scale(1) rotate(240deg); opacity: 0.2;} /* End more transparent */
        }

        #custom-cursor {
            position: fixed;
            width: 28px; /* Slightly larger heart */
            height: 28px;
            /* Pink heart cursor */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FF8FAB'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease-out, width 0.2s ease, height 0.2s ease;
            display: none; 
        }
        
        @media (min-width: 1024px) { 
            #custom-cursor {
                display: block;
            }
        }
         @media (max-width: 1023px) { 
            body {
                cursor: auto;
            }
        }

        .btn:hover ~ #custom-cursor, input:hover ~ #custom-cursor, button:hover ~ #custom-cursor {
            transform: translate(-50%, -50%) scale(1.4) rotate(10deg); /* More playful hover effect for cursor */
        }
        
        .error-message-card {
            background-color: #ffebee; 
            border: 2px solid #f44336; 
            color: #c62828; 
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.2);
        }

        /* Ensure responsive text sizes */
        h1 { font-size: clamp(2rem, 5vw, 3rem); } /* Responsive heading */
        p, label, button, input, span { font-size: clamp(0.875rem, 2.5vw, 1.125rem); } /* Responsive body text */
        .result-card p strong, .result-card span { font-size: clamp(1rem, 3vw, 1.25rem); } /* Result text */


    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">
    <div id="background-elements-container"></div>
    <div id="custom-cursor"></div>

    <div class="container w-full max-w-lg mx-auto my-4 sm:my-8 px-4 py-6 sm:px-6 sm:py-8 md:px-8 md:py-10">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="font-bold text-pink-500" style="text-shadow: 2px 2px 0px #fff, 3px 3px 0px rgba(255,175,204,0.5);">ìºì¹˜! í‹°ë‹ˆí•‘ ìºë¦­í„° ìƒì„±ê¸°</h1>
            <p class="text-gray-600 mt-2 sm:mt-3">ë‚˜ë§Œì˜ ì‚¬ë‘ìŠ¤ëŸ¬ìš´ í‹°ë‹ˆí•‘ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
        </header>

        <div id="nameSection" class="section-card p-4 sm:p-6">
            <label for="userName" class="block font-semibold text-gray-700 mb-2 sm:mb-3">í‹°ë‹ˆí•‘ì—ê²Œ ì–´ë–¤ ì´ë¦„ì„ ì§€ì–´ì¤„ê¹Œìš”?</label>
            <input type="text" id="userName" class="w-full p-2.5 sm:p-3 border-2 border-pink-200 rounded-lg shadow-sm focus:ring-pink-400 focus:border-pink-400 focus:shadow-lg" placeholder="ì˜ˆ: í•˜ì¸„í•‘">
            <button id="submitNameBtn" class="btn btn-primary w-full mt-4 sm:mt-5 py-2.5 sm:py-3 rounded-lg">ì´ë¦„ ì •í•˜ê¸° ì™„ë£Œ!</button>
        </div>

        <div id="customizationSection" class="hidden">
            </div>
        
        <div id="loadingSection" class="hidden text-center py-8 sm:py-10">
            <p class="font-semibold text-pink-500 mb-2 sm:mb-3">í‹°ë‹ˆí•‘ ë³€ì‹  ì¤‘...</p>
            <div class="loading-spinner mx-auto"></div>
            <p class="text-gray-600 mt-2 sm:mt-3">ë§ˆë²•ì˜ í˜ìœ¼ë¡œ ì˜ˆìœ í‹°ë‹ˆí•‘ì„ ë§Œë“¤ê³  ìˆì–´ìš”! <br> (ë°˜ì§ë°˜ì§... ì–´ë–¤ í‹°ë‹ˆí•‘ì´ ë‚˜ì˜¬ê¹Œìš”?)</p>
        </div>

        <div id="resultSection" class="hidden text-center">
            <h2 id="resultTitle" class="font-bold mb-4 sm:mb-5 text-pink-600" style="text-shadow: 1px 1px 0px #fff;"></h2>
            <img id="characterImage" src="https://placehold.co/300x300/fff0f3/FFC0CB?text=í‹°ë‹ˆí•‘+ì¤€ë¹„ì¤‘&font=jua" alt="í‹°ë‹ˆí•‘ ì´ë¯¸ì§€" class="result-image">
            <div class="result-card p-4 sm:p-6">
                <p class="mb-2 sm:mb-3"><strong>ğŸ’– í‹°ë‹ˆí•‘ ì´ë¦„:</strong> <span id="teeniepingNameDisplay" class="font-bold text-pink-500"></span></p>
                <p class="mb-2 sm:mb-3"><strong>âœ¨ íŠ¹ì§•:</strong> <span id="teeniepingFeatureDisplay" class="font-bold text-pink-500"></span></p>
                <p class="mb-2 sm:mb-3"><strong>ğŸ€ ë§ˆë²• ì•„ì´í…œ:</strong> <span id="magicItemDisplay" class="font-bold text-pink-500"></span></p>
                <p class="mt-3 sm:mt-4 leading-relaxed"><strong>ğŸŒŸ ì„±ê²©:</strong> <span id="personalityDisplay"></span></p>
            </div>
            <button id="retryBtn" class="btn btn-primary w-full mt-6 sm:mt-8 py-3 sm:py-3.5 rounded-lg">ë‹¤ë¥¸ í‹°ë‹ˆí•‘ ë§Œë“¤ê¸°!</button>
        </div>

        <div id="errorMessage" class="hidden mt-4 sm:mt-5 p-3 sm:p-4 error-message-card">
            </div>
    </div>

    <script>
        // DOM Elements
        const nameSection = document.getElementById('nameSection');
        const customizationSection = document.getElementById('customizationSection');
        const loadingSection = document.getElementById('loadingSection');
        const resultSection = document.getElementById('resultSection');
        
        const submitNameBtn = document.getElementById('submitNameBtn');
        const userNameInput = document.getElementById('userName');
        
        const resultTitle = document.getElementById('resultTitle');
        const characterImage = document.getElementById('characterImage');
        const teeniepingNameDisplay = document.getElementById('teeniepingNameDisplay');
        const teeniepingFeatureDisplay = document.getElementById('teeniepingFeatureDisplay');
        const magicItemDisplay = document.getElementById('magicItemDisplay');
        const personalityDisplay = document.getElementById('personalityDisplay');

        const retryBtn = document.getElementById('retryBtn');
        const errorMessageDiv = document.getElementById('errorMessage');

        const backgroundElementsContainer = document.getElementById('background-elements-container');
        const customCursor = document.getElementById('custom-cursor');

        // Background elements (stars/hearts/etc.)
        const numElements = 25; // More elements for a richer background
        const elementTypes = ['â­', 'ğŸ’–', 'âœ¨', 'ğŸŒ¸', 'ğŸ€', 'ğŸ’•', 'ğŸŒŸ']; 
        for (let i = 0; i < numElements; i++) {
            const element = document.createElement('div');
            element.classList.add('background-element');
            element.textContent = elementTypes[Math.floor(Math.random() * elementTypes.length)];
            const size = Math.random() * 18 + 12; 
            element.style.fontSize = `${size}px`;
            element.style.left = `${Math.random() * 100}vw`;
            element.style.top = `${Math.random() * 100}vh`;
            element.style.animationDelay = `${Math.random() * 12}s`; 
            element.style.animationDuration = `${Math.random() * 12 + 18}s`; 
            const pastelColors = [
                'rgba(255,192,203,0.7)', 'rgba(255,179,193,0.7)', 'rgba(251,111,146,0.6)', 
                'rgba(255,223,230,0.7)', 'rgba(255, 209, 220, 0.7)'
            ]; // More pink shades
            element.style.color = pastelColors[Math.floor(Math.random() * pastelColors.length)];
            backgroundElementsContainer.appendChild(element);
        }

        // Custom cursor logic
        if (window.matchMedia("(min-width: 1024px)").matches) {
            document.addEventListener('mousemove', (e) => {
                customCursor.style.left = `${e.clientX}px`;
                customCursor.style.top = `${e.clientY}px`;
            });
            document.addEventListener('mousedown', () => customCursor.style.transform = 'translate(-50%, -50%) scale(0.8) rotate(-15deg)');
            document.addEventListener('mouseup', () => customCursor.style.transform = 'translate(-50%, -50%) scale(1) rotate(0deg)');
        }

        // Teenieping customization questions
        // Define outfit options separately for male, female, and all
        const femaleOutfitOptions = [
            { text: "ë°˜ì§ì´ëŠ” ë³„ë¹› ìš”ì • ë“œë ˆìŠ¤", value: "sparkling starlight fairy dress" },
            { text: "ë‹¬ì½¤í•œ í”„ë¦´ ì¼€ì´í¬ ì›í”¼ìŠ¤", value: "sweet frilly cake one-piece" },
            { text: "í•˜ëŠ˜í•˜ëŠ˜ ë¦¬ë³¸ ì²´ì¡°ë³µ", value: "airy ribbon gymnastic suit" },
            { text: "ê¿ˆë‚˜ë¼ ê³µì£¼ë‹˜ ë¬´ë„íšŒ ë“œë ˆìŠ¤", value: "dreamland princess ball gown" },
            { text: "ê½ƒì ìƒ¤ë„ë¼ ë°œë ˆë¦¬ë‚˜ ì˜ìƒ", value: "petal shalalala ballerina costume"}
        ];

        const maleOutfitOptions = [
            { text: "ìš©ê°í•œ ê¼¬ë§ˆì™•ìë‹˜ ì •ì¥", value: "brave little prince suit" },
            { text: "ì‹ ë‚˜ëŠ” íƒí—˜ê°€ ëª¨í—˜ë³µ", value: "exciting explorer adventure clothes" },
            { text: "ê·€ì—¬ìš´ ë™ë¬¼ íŒŒì¼ëŸ¿ ìœ ë‹ˆí¼", value: "cute animal pilot uniform" },
            { text: "ê¼¬ë§ˆ ë§ˆë²•ì‚¬ ë¡œë¸Œì™€ ëª¨ì", value: "little wizard robe and hat" },
            { text: "ì¥ë‚œê¾¸ëŸ¬ê¸° ìš”ì • ì í”„ìˆ˜íŠ¸", value: "mischievous fairy jumpsuit"}
        ];
        
        const allOutfitOptions = [...new Set([...femaleOutfitOptions, ...maleOutfitOptions].map(JSON.stringify))].map(JSON.parse);


        const teeniepingQuestions = [
            {
                id: 'gender',
                text: "í‹°ë‹ˆí•‘ì˜ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!",
                options: [
                    { text: "ë‚¨ìì•„ì´ í‹°ë‹ˆí•‘", value: "male" },
                    { text: "ì—¬ìì•„ì´ í‹°ë‹ˆí•‘", value: "female" },
                    { text: "ë¹„ë°€ í‹°ë‹ˆí•‘", value: "secret" }
                ]
            },
            {
                id: 'hairColor',
                text: "í‹°ë‹ˆí•‘ì˜ í—¤ì–´ ìƒ‰ìƒì„ ê³¨ë¼ì£¼ì„¸ìš”! ì–´ë–¤ íŒŒìŠ¤í…”í†¤ ìƒ‰ìƒì„ ì¢‹ì•„í•˜ë‚˜ìš”?",
                options: [
                    { text: "ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ë”¸ê¸°ìš°ìœ  í•‘í¬", value: "strawberry milk pink" },
                    { text: "ìƒí¼í†¡í†¡ ë¯¼íŠ¸ì´ˆì½”ì¹©", value: "mint chocolate chip" },
                    { text: "ê¿ˆê¾¸ëŠ”ë“¯í•œ ë¼ë²¤ë” ë°”ì´ì˜¬ë ›", value: "dreamy lavender violet" },
                    { text: "í–‡ì‚´ê°€ë“ ë ˆëª¬ì˜ë¡œ", value: "sunshine lemon yellow" },
                    { text: "ë­‰ê²Œêµ¬ë¦„ ìŠ¤ì¹´ì´ë¸”ë£¨", value: "fluffy sky blue" }
                ]
            },
            {
                id: 'animalEars',
                text: "í‹°ë‹ˆí•‘ì—ê²Œ ì–´ë–¤ ë™ë¬¼ì˜ ê·€ë¥¼ ë‹¬ì•„ì¤„ê¹Œìš”?",
                options: [
                    { text: "ì«‘ê¸‹ì«‘ê¸‹ ì•„ê¸°í† ë¼ ê·€", value: "baby rabbit" },
                    { text: "ìƒˆì¹¨í•œ ì•„ê¸°ê³ ì–‘ì´ ê·€", value: "kitten" },
                    { text: "ë™ê¸€ë™ê¸€ ì•„ê¸°ê³° ê·€", value: "teddy bear" },
                    { text: "ì•™í¼ìƒí¼ ì•„ê¸°ì—¬ìš° ê·€", value: "baby fox" },
                    { text: "ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì•„ê¸°ê°•ì•„ì§€ ê·€", value: "puppy" }
                ]
            },
            {
                id: 'outfit',
                text: "í‹°ë‹ˆí•‘ì—ê²Œ ì–´ë–¤ ì˜·ì„ ì…íê¹Œìš”? ìƒê°ë§Œ í•´ë„ ë‘ê·¼ë‘ê·¼!",
                // Options will be dynamically set based on gender
            }
        ];

        let userSelections = {}; 
        let currentQuestionIndex = 0;
        const apiKey = ""; // IMPORTANT: Keep this empty for Canvas environment auto-key injection

        function displayError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            errorMessageDiv.style.opacity = '0';
            setTimeout(() => { errorMessageDiv.style.opacity = '1'; }, 50);
            setTimeout(() => { 
                errorMessageDiv.style.opacity = '0';
                setTimeout(() => errorMessageDiv.classList.add('hidden'), 500);
            }, 5000); 
        }

        function showNextSection(currentSection, nextSection) {
            currentSection.style.animation = 'fadeOutSlideUp 0.4s forwards';
            setTimeout(() => {
                currentSection.classList.add('hidden');
                currentSection.style.animation = ''; 

                nextSection.classList.remove('hidden');
                void nextSection.offsetWidth; 
                nextSection.style.animation = 'fadeInSlideUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
            }, 400);
        }
        
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes fadeOutSlideUp {
                from { opacity: 1; transform: translateY(0) scale(1); }
                to { opacity: 0; transform: translateY(-25px) scale(0.95); }
            }
        `;
        document.head.appendChild(styleSheet);

        submitNameBtn.addEventListener('click', () => {
            const name = userNameInput.value.trim();
            if (!name) {
                displayError("í‹°ë‹ˆí•‘ì˜ ì´ë¦„ì„ ì§€ì–´ì¤˜ì•¼ í•´ìš”! ê·¸ë˜ì•¼ ë§ˆë²•ì´ ì‹œì‘ëœë‹µë‹ˆë‹¤!");
                return;
            }
            userSelections = { name }; 
            currentQuestionIndex = 0; 
            showNextSection(nameSection, customizationSection);
            renderCurrentCustomizationQuestion();
        });

        function renderCurrentCustomizationQuestion() {
            customizationSection.innerHTML = ''; 
            if (currentQuestionIndex < teeniepingQuestions.length) {
                const q = teeniepingQuestions[currentQuestionIndex];
                let currentOptions = q.options;

                // Dynamically set outfit options based on gender
                if (q.id === 'outfit') {
                    const selectedGender = userSelections.gender;
                    if (selectedGender === 'male') {
                        currentOptions = maleOutfitOptions;
                    } else if (selectedGender === 'female') {
                        currentOptions = femaleOutfitOptions;
                    } else { // secret or undefined
                        currentOptions = allOutfitOptions;
                    }
                }


                const questionDiv = document.createElement('div');
                questionDiv.classList.add('section-card', 'p-4', 'sm:p-6');
                questionDiv.innerHTML = `
                    <p class="text-sm sm:text-base font-semibold mb-1 text-pink-400">ğŸ’– í‹°ë‹ˆí•‘ ê¾¸ë¯¸ê¸° ${currentQuestionIndex + 1}/${teeniepingQuestions.length} ğŸ’–</p>
                    <p class="text-lg sm:text-xl mb-3 sm:mb-4 font-medium text-gray-700">${q.text}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                        ${currentOptions.map(opt => `
                            <button data-question-id="${q.id}" data-value="${opt.value}" class="w-full text-left p-3 sm:p-3.5 border rounded-lg shadow-sm choice-btn btn text-sm sm:text-base">
                                ${opt.text}
                            </button>
                        `).join('')}
                    </div>
                `;
                customizationSection.appendChild(questionDiv);
                void questionDiv.offsetWidth; 
                questionDiv.style.animation = 'fadeInSlideUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';

                document.querySelectorAll('.choice-btn').forEach(button => {
                    button.addEventListener('click', handleCustomizationOptionSelect);
                });
            } else {
                showNextSection(customizationSection, loadingSection);
                generateAndShowTeenieping();
            }
        }

        function handleCustomizationOptionSelect(event) {
            const selectedButton = event.currentTarget;
            const questionId = selectedButton.dataset.questionId; 
            const value = selectedButton.dataset.value;
            userSelections[questionId] = value;

            const parentQuestionCard = selectedButton.closest('.section-card');
            parentQuestionCard.querySelectorAll('.choice-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('selected'); 
                if (btn !== selectedButton) { // Keep selected button's style, dim others
                    btn.classList.add('opacity-50');
                }
            });
            selectedButton.classList.add('selected');
            selectedButton.classList.remove('opacity-50');


            setTimeout(() => {
                currentQuestionIndex++;
                if (parentQuestionCard) {
                    parentQuestionCard.style.animation = 'fadeOutSlideUp 0.4s forwards';
                    setTimeout(() => {
                        parentQuestionCard.remove(); 
                        renderCurrentCustomizationQuestion(); 
                    }, 400);
                } else {
                     renderCurrentCustomizationQuestion();
                }
            }, 300); // Slightly faster transition
        }

        const teeniepingCorePromptBase = `Adorable 3D Teenieping [GENDER_TAG] fairy character in Korean Catch Teenieping style:
- Style: Chibi proportions, large head, exceptionally cute face.
- Eyes: Big, sparkling, expressive anime eyes with multiple star-shaped and circular reflections, long eyelashes.
- Hair: Pastel [COLOR] hair, styled with ribbons, bows, or small flowers. Has [ANIMAL_EAR_STYLE] ears seamlessly integrated or as a headband.
- Outfit: Wearing an elaborate, frilly, layered [OUTFIT_STYLE] in various pastel shades (especially pinks, lavenders, mints, baby blues, yellows), adorned with cute decorations like hearts, stars, bows, lace, and tiny gems.
- Wings: Delicate, transparent, iridescent fairy wings with subtle glitter.
- Accessory: Holding a tiny, cute character charm or a miniature magical accessory (e.g., a star wand, a flower staff, a tiny teacup, a small musical instrument).
- Rendering: Soft, high-quality 3D rendering, smooth textures, pastel color palette dominant. Bright, cheerful, magical mood.
- Background: Clean white or a very soft, dreamy pastel gradient background (e.g., light pink to light blue, or a soft rainbow).
- Decorative Elements: Subtle floating elements like tiny stars, glowing particles, small hearts, or flower petals around the character.
- Overall: Quintessential Korean animation fairy style, high quality, highly detailed, polished, exceptionally adorable and charming.`;

        async function generateAndShowTeenieping() {
            resultSection.classList.add('hidden'); 
            characterImage.src = "https://placehold.co/300x300/fff0f3/FFC0CB?text=í‹°ë‹ˆí•‘+ë³€ì‹ ì¤‘...&font=jua";
            characterImage.alt = "í‹°ë‹ˆí•‘ ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
            resultTitle.textContent = `ì§œì”! ${userSelections.name} í‹°ë‹ˆí•‘ ë“±ì¥!`;

            let genderTag = ""; 
            let genderDesc = "ë¹„ë°€ìŠ¤ëŸ¬ìš´"; 
            if (userSelections.gender === "male") {
                genderTag = "boy"; // Explicitly set for male
                genderDesc = "ìš©ê°í•œ ë‚¨ìì•„ì´";
            } else if (userSelections.gender === "female") {
                genderTag = "girl"; // Explicitly set for female
                genderDesc = "ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì—¬ìì•„ì´";
            }
            // If 'secret', genderTag remains empty, leading to a more neutral depiction if the model interprets it that way.
            
            let animalEarDescription = "cute animal ears"; // Default description
            if (userSelections.animalEars) {
                animalEarDescription = `${userSelections.animalEars} ears`; 
            }

            const selectedOutfit = userSelections.outfit || "a very cute and adorable outfit";


            let imagePrompt = teeniepingCorePromptBase
                .replace("[GENDER_TAG]", genderTag.trim()) // Use trim to remove potential leading/trailing spaces if genderTag is empty
                .replace("[COLOR]", userSelections.hairColor || "pink") 
                .replace("[ANIMAL_EAR_STYLE]", animalEarDescription) 
                .replace("[OUTFIT_STYLE]", selectedOutfit); 
            
            // If gender is secret, we might want to make the GENDER_TAG part of the prompt less prominent or remove it
            if (userSelections.gender === "secret") {
                imagePrompt = imagePrompt.replace("Teenieping [GENDER_TAG] fairy character", "Teenieping fairy character"); // Make it more neutral
            }


            console.log("Final Image Prompt for Generation:", imagePrompt);

            let imageGenerated = false;
            try {
                const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const imageResponse = await fetch(imageApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: [{ prompt: imagePrompt }], parameters: { "sampleCount": 1, "aspectRatio": "1:1" } }) 
                });
                if (!imageResponse.ok) {
                    console.error("Image API Error Response Status:", imageResponse.status); 
                    const responseText = await imageResponse.text(); 
                    console.error("Image API Error Response Text:", responseText); 
                    let errorMsg = `Status: ${imageResponse.status}`;
                    try {
                        const errorData = JSON.parse(responseText); 
                        errorMsg = errorData.error?.message || errorMsg; 
                    } catch (e) {
                        if (responseText && responseText.length < 200 && responseText.trim() !== "") {
                           errorMsg = `${errorMsg} - ${responseText.substring(0,100)}...`; 
                        }
                    }
                    throw new Error(`ì´ë¯¸ì§€ ìƒì„± API ì˜¤ë¥˜: ${errorMsg}`);
                }
                const imageData = await imageResponse.json();
                if (imageData.predictions && imageData.predictions.length > 0 && imageData.predictions[0].bytesBase64Encoded) {
                    characterImage.src = `data:image/png;base64,${imageData.predictions[0].bytesBase64Encoded}`;
                    imageGenerated = true;
                } else {
                    console.error("Image API Success Response but no image data:", imageData);
                    throw new Error("API ì‘ë‹µì—ì„œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('Error generating image:', error);
                characterImage.src = "https://placehold.co/300x300/fce4ec/c2185b?text=ì´ë¯¸ì§€+ìƒì„±+ì‹¤íŒ¨&font=jua";
                displayError(`í‹°ë‹ˆí•‘ ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ${error.message}. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!`);
            }

            const textGenPrompt = `
                ì‚¬ìš©ìê°€ ì„ íƒí•œ í‹°ë‹ˆí•‘ ì •ë³´:
                - ì´ë¦„: ${userSelections.name}
                - ì„±ë³„: ${genderDesc}
                - í—¤ì–´ ìƒ‰ìƒ: ${userSelections.hairColor}
                - ë™ë¬¼ ê·€: ${userSelections.animalEars}
                - ì˜ìƒ: ${userSelections.outfit}

                ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì•„ì£¼ ê·€ì—½ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ìºì¹˜! í‹°ë‹ˆí•‘ ìºë¦­í„° ì„¤ëª…ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
                ì´ë¦„ì€ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì´ë¦„ì— 'í•‘'ì„ ë¶™ì´ê±°ë‚˜, íŠ¹ì§•ì„ ì‚´ë ¤ ì°½ì˜ì ìœ¼ë¡œ ì§€ì–´ì£¼ì„¸ìš”. (ì˜ˆ: '${userSelections.name}í•‘', 'í•‘í¬${userSelections.animalEars}í•‘')
                íŠ¹ì§•, ë§ˆë²• ì•„ì´í…œ, ì„±ê²©ì€ ê° ì„ íƒì§€ì™€ ì–´ìš¸ë¦¬ë©´ì„œë„ ë§¤ìš° ì‚¬ë‘ìŠ¤ëŸ½ê³  ë™í™”ì ì¸ ëŠë‚Œìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
                {
                  "teeniepingName": "ìµœì¢… í‹°ë‹ˆí•‘ ì´ë¦„",
                  "teeniepingFeature": "ìºë¦­í„°ì˜ ì£¼ìš” íŠ¹ì§• (ì˜ˆ: '${userSelections.hairColor}ìƒ‰ ${userSelections.animalEars} ê·€ë¥¼ ê°€ì§„ ${genderDesc} ê°ì •ì˜ ìš”ì •')",
                  "magicItem": "ìºë¦­í„°ê°€ ê°€ì§„ íŠ¹ë³„í•œ ë§ˆë²• ì•„ì´í…œ ì´ë¦„ (ì˜ˆ: 'ë°˜ì§ì´ëŠ” ${userSelections.hairColor} í•˜íŠ¸ ìš”ìˆ ë´‰', 'ë¬´ì§€ê°œë¹› ${userSelections.animalEars} ë³„ê°€ë£¨ ì£¼ë¨¸ë‹ˆ')",
                  "personality": "ìºë¦­í„°ì˜ ì„±ê²©ì„ í•œë‘ ë¬¸ì¥ìœ¼ë¡œ ê·€ì—½ê²Œ ë¬˜ì‚¬ (ì˜ˆ: '${userSelections.outfit}ì„ ì…ê³  ì„¸ìƒì„ íƒí—˜í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ëŠ” í˜¸ê¸°ì‹¬ ë§ê³  ë‹¤ì •í•œ í‹°ë‹ˆí•‘ì´ì—ìš”.')"
                }
            `;
            
            console.log("Text Gen Prompt:", textGenPrompt);

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: textGenPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "teeniepingName": { "type": "STRING" },
                                "teeniepingFeature": { "type": "STRING" },
                                "magicItem": { "type": "STRING" },
                                "personality": { "type": "STRING" }
                            },
                            required: ["teeniepingName", "teeniepingFeature", "magicItem", "personality"]
                        }
                    }
                };
                const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const textResponse = await fetch(textApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                 if (!textResponse.ok) {
                    console.error("Text API Error Response Status:", textResponse.status); 
                    const responseText = await textResponse.text(); 
                    console.error("Text API Error Response Text:", responseText); 
                    let errorMsg = `Status: ${textResponse.status}`;
                    try {
                        const errorData = JSON.parse(responseText); 
                        errorMsg = errorData.error?.message || errorMsg; 
                    } catch (e) {
                        if (responseText && responseText.length < 200 && responseText.trim() !== "") {
                           errorMsg = `${errorMsg} - ${responseText.substring(0,100)}...`; 
                        }
                    }
                    throw new Error(`í‹°ë‹ˆí•‘ ì •ë³´ ìƒì„± API ì˜¤ë¥˜: ${errorMsg}`);
                }
                const textData = await textResponse.json();
                if (textData.candidates && textData.candidates[0]?.content?.parts[0]?.text) {
                    const resultJson = JSON.parse(textData.candidates[0].content.parts[0].text);
                    teeniepingNameDisplay.textContent = resultJson.teeniepingName;
                    teeniepingFeatureDisplay.textContent = resultJson.teeniepingFeature;
                    magicItemDisplay.textContent = resultJson.magicItem;
                    personalityDisplay.textContent = resultJson.personality;
                } else {
                    console.error("Text API Success Response but no text data:", textData);
                    throw new Error("API ì‘ë‹µì—ì„œ í‹°ë‹ˆí•‘ ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('Error generating text data:', error);
                teeniepingNameDisplay.textContent = userSelections.name + "í•‘"; // Fallback
                teeniepingFeatureDisplay.textContent = "ë§ˆë²•ì˜ ì˜¤ë¥˜ë¡œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”!";
                magicItemDisplay.textContent = "ë°˜ì§ì´ëŠ” ë°ì´í„° ë³µêµ¬ ìŠ¤í‹±";
                personalityDisplay.textContent = "ì§€ê¸ˆì€ ì¡°ê¸ˆ ë‹¹í™©í–ˆì§€ë§Œ, ì´ í‹°ë‹ˆí•‘ì€ ë¶„ëª… ì•„ì£¼ íŠ¹ë³„í•  ê±°ì˜ˆìš”!";
                displayError(`í‹°ë‹ˆí•‘ ìƒì„¸ ì •ë³´ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ${error.message}. ê·¸ë˜ë„ ê±±ì • ë§ˆì„¸ìš”, ìƒìƒ ì† í‹°ë‹ˆí•‘ì€ ì™„ë²½í•˜ë‹ˆê¹Œìš”!`);
            } finally {
                showNextSection(loadingSection, resultSection);
            }
        }

        retryBtn.addEventListener('click', () => {
            showNextSection(resultSection, nameSection);
            userNameInput.value = '';
            userSelections = {};
            currentQuestionIndex = 0;
            characterImage.src = "https://placehold.co/300x300/fff0f3/FFC0CB?text=í‹°ë‹ˆí•‘+ì¤€ë¹„ì¤‘&font=jua";
            characterImage.alt = "í‹°ë‹ˆí•‘ ì´ë¯¸ì§€";
            teeniepingNameDisplay.textContent = "";
            teeniepingFeatureDisplay.textContent = "";
            magicItemDisplay.textContent = "";
            personalityDisplay.textContent = "";
            errorMessageDiv.classList.add('hidden');
            errorMessageDiv.style.opacity = '0';
        });
        
        window.addEventListener('load', () => {
            nameSection.style.animation = 'fadeInSlideUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
        });

    </script>
</body>
</html>
