<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학교의 미스터리: AI 탐정 노트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 로딩 스피너 애니메이션 */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 스크롤바 디자인 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-700 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- 캐릭터 생성 모달 -->
    <div id="character-modal" class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
        <h1 class="text-3xl font-bold mb-4">학교의 미스터리</h1>
        <p class="text-gray-400 mb-6">AI 탐정 노트에 오신 것을 환영합니다. 당신의 이름을 알려주세요.</p>
        <form id="character-form">
            <input type="text" id="character-name" placeholder="탐정의 이름" class="w-full bg-gray-700 text-white p-3 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <select id="character-trait" class="w-full bg-gray-700 text-white p-3 rounded-md mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="관찰력이 뛰어난 학생">특징: 관찰력이 뛰어남</option>
                <option value="운동 신경이 좋은 학생">특징: 운동 신경이 좋음</option>
                <option value="친구가 많은 학생">특징: 친구가 많음</option>
            </select>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">
                미스터리 시작하기
            </button>
        </form>
    </div>

    <!-- 메인 게임 컨테이너 -->
    <div id="game-container" class="hidden w-full max-w-4xl h-[90vh] bg-gray-800 rounded-lg shadow-2xl flex flex-col p-4 md:p-6">
        <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
            <!-- 왼쪽: 이미지 및 스토리 -->
            <div class="md:w-1/2 flex flex-col gap-4">
                <div id="image-display" class="w-full h-64 md:h-1/2 bg-gray-900 rounded-lg flex items-center justify-center overflow-hidden border border-gray-700">
                    <p class="text-gray-500">장면 이미지가 여기에 표시됩니다.</p>
                </div>
                <div id="story-text-container" class="flex-grow bg-gray-900 rounded-lg p-4 custom-scrollbar overflow-y-auto border border-gray-700">
                    <p id="story-text" class="text-gray-300 whitespace-pre-wrap leading-relaxed"></p>
                </div>
            </div>
            <!-- 오른쪽: 선택지 및 미스터리 노트 -->
            <div class="md:w-1/2 flex flex-col gap-4">
                <div id="choices-container" class="flex flex-col gap-3">
                    <!-- 선택지 버튼이 여기에 동적으로 추가됩니다. -->
                </div>
                <div class="flex-grow flex flex-col">
                     <h2 class="text-xl font-bold mb-2 border-b-2 border-gray-700 pb-2 flex justify-between items-center">
                        <span>미스터리 노트</span>
                        <span id="player-info" class="text-sm font-normal text-gray-400"></span>
                    </h2>
                    <ul id="mystery-note" class="bg-gray-900 rounded-lg p-4 flex-grow custom-scrollbar overflow-y-auto border border-gray-700 list-disc list-inside text-gray-400 space-y-2">
                        <li>아직 발견된 단서가 없습니다.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // DOM 요소 가져오기
        const characterModal = document.getElementById('character-modal');
        const characterForm = document.getElementById('character-form');
        const gameContainer = document.getElementById('game-container');
        const imageDisplay = document.getElementById('image-display');
        const storyText = document.getElementById('story-text');
        const choicesContainer = document.getElementById('choices-container');
        const mysteryNote = document.getElementById('mystery-note');
        const playerInfo = document.getElementById('player-info');

        // 게임 상태 관리
        let gameState = {
            character: {
                name: '',
                trait: '',
            },
            currentScene: 'start',
            notes: [],
        };

        // 시나리오 데이터 (PRD 기반)
        const storyData = {
            'start': {
                text: "평범한 오후의 종업식. 담임 선생님이 들어오시더니 심각한 표정으로 말씀하셨다.\n'여러분, 큰일났습니다. 우리 학교의 상징인 과학실의 인체 모형, '철수'가 사라졌어요! 혹시 어제 방과 후에 과학실 근처에 갔던 사람 있나요?'\n교실은 순간 술렁이기 시작했다. 나는 탐정으로서 이 사건을 해결해야겠다고 다짐했다.",
                imagePrompt: "An anime-style illustration of a sunlit, slightly noisy classroom. A teacher stands at the front with a serious expression, and students are whispering to each other with surprised faces.",
                choices: [
                    { text: "가장 친한 친구에게 말을 건다.", nextScene: 'talk_to_friend' },
                    { text: "아무도 모르게 과학실로 향한다.", nextScene: 'go_to_lab' },
                    { text: "선생님께 제가 찾아보겠다고 말한다.", nextScene: 'talk_to_teacher' },
                ]
            },
            'talk_to_friend': {
                text: "나는 가장 친한 친구인 '민준'에게 다가가 물었다. '민준아, 너 혹시 어제 과학실 근처에서 이상한 거 못 봤어?'\n민준이는 잠시 고민하더니 입을 열었다. '글쎄... 어제 늦게까지 축구 연습을 했는데, 과학실 쪽 창문에서 희미한 손전등 불빛 같은 걸 본 것 같기도 해.'",
                imagePrompt: "An anime-style illustration of two male students whispering in a classroom corner. One is asking a question seriously, and the other is scratching his head, trying to remember something.",
                choices: [
                    { text: "손전등 불빛에 대해 더 자세히 묻는다.", nextScene: 'ask_more_details', clue: "친구 민준이가 어젯밤 과학실 창문에서 손전등 불빛을 목격함." },
                    { text: "고맙다고 하고 과학실로 향한다.", nextScene: 'go_to_lab' },
                ]
            },
            'go_to_lab': {
                text: "나는 조용히 교실을 빠져나와 1층에 있는 과학실로 향했다. 문은 굳게 잠겨 있었다. 하지만 문 옆의 작은 창문이 살짝 열려있는 것을 발견했다. 창문은 꽤 높이 있었지만, 나의 특징을 이용하면 들어갈 수 있을 것 같다.",
                imagePrompt: "An anime-style illustration of a locked door to a school science lab. Beside the door, a small window is slightly ajar. The hallway is quiet and empty.",
                choices: [
                    { text: "창문을 넘어 안으로 들어간다.", nextScene: 'enter_lab_through_window', requires: "운동 신경이 좋은 학생" },
                    { text: "주변에 다른 들어갈 방법이 있는지 찾아본다.", nextScene: 'search_around_lab' },
                    { text: "일단 교실로 돌아가 다른 단서를 찾는다.", nextScene: 'start' },
                ]
            },
            'talk_to_teacher': {
                text: "나는 손을 번쩍 들고 말했다. '선생님! 제가 한번 찾아보겠습니다!'\n선생님은 놀라면서도 기특하다는 듯 나를 보셨다. '정말이냐? 고맙구나. 여기 과학실 열쇠다. 하지만 절대 무리하지는 말거라. 위험한 물건도 많으니까.'",
                imagePrompt: "An anime-style illustration of a student bravely raising their hand in a classroom. The teacher looks surprised but hands over a key with a grateful expression.",
                choices: [
                    { text: "열쇠를 받아들고 과학실로 향한다.", nextScene: 'go_to_lab_with_key', clue: "선생님께 과학실 열쇠를 받았다." },
                ]
            },
            'go_to_lab_with_key': {
                 text: "선생님께 받은 열쇠로 과학실 문을 열고 안으로 들어갔다. '철수'가 있던 자리에는 텅 빈 받침대만 덩그러니 놓여 있었다. 주변을 둘러보니, 바닥에 반짝이는 작은 물건이 떨어져 있었다.",
                 imagePrompt: "An anime-style illustration of the inside of a school science lab. An empty stand is in the center, and various beakers and equipment are on the shelves. A small, shiny object is visible on the floor.",
                 choices: [
                    { text: "바닥의 물건을 줍는다.", nextScene: 'find_clue_in_lab' },
                    { text: "창문 쪽을 먼저 살펴본다.", nextScene: 'check_window_from_inside' },
                 ]
            },
            'find_clue_in_lab': {
                text: "바닥에 떨어진 것을 주워보니, 그것은 낡은 은색 단추였다. 우리 학교 교복의 단추와는 모양이 달랐다. 아마 범인이 떨어뜨린 것일지도 모른다.",
                imagePrompt: "A close-up, anime-style illustration of a hand holding an old, ornate silver button. It looks different from a standard uniform button.",
                choices: [
                    { text: "단추를 주머니에 넣고 다른 단서를 찾는다.", nextScene: 'search_more_in_lab', clue: "과학실 바닥에서 낡은 은색 단추를 발견했다." },
                    { text: "이 단추에 대해 친구들에게 물어보기로 한다.", nextScene: 'ask_about_button', requires: "친구가 많은 학생" },
                ]
            },
            'enter_lab_through_window': {
                text: "운동 신경을 발휘해, 나는 벽을 딛고 창문을 넘어 과학실 안으로 조용히 들어오는 데 성공했다. 안은 정적만이 감돌았다. '철수'가 있던 자리에는 텅 빈 받침대만 덩그러니 놓여 있었다. 주변을 둘러보니, 바닥에 반짝이는 작은 물건이 떨어져 있었다.",
                imagePrompt: "An anime-style illustration of the inside of a school science lab, seen from the perspective of someone who just climbed through a window. An empty stand is in the center, and a small, shiny object is on the floor.",
                choices: [
                    { text: "바닥의 물건을 줍는다.", nextScene: 'find_clue_in_lab' },
                    { text: "창문 쪽을 먼저 살펴본다.", nextScene: 'check_window_from_inside' },
                ]
            },
            'search_around_lab': {
                text: "나는 과학실 주변을 샅샅이 뒤져보았다. 하지만 뒷문도 잠겨있고, 다른 들어갈 만한 통로는 보이지 않았다. 역시 창문이 유일한 방법인 것 같다.",
                imagePrompt: "An anime-style illustration of the back of a school building, showing a locked door and no other visible entrances. The character looks slightly disappointed.",
                choices: [
                    { text: "창문을 넘어 안으로 들어간다.", nextScene: 'enter_lab_through_window', requires: "운동 신경이 좋은 학생" },
                    { text: "교실로 돌아가 선생님께 여쭤본다.", nextScene: 'talk_to_teacher' },
                ]
            },
            'ask_more_details': {
                text: "나는 민준이에게 더 자세히 물었다. '그 불빛, 혹시 몇 시쯤이었는지, 사람은 없었는지 기억나?' 민준이는 고개를 갸웃거리며 말했다. '음... 꽤 늦은 시간이었어. 9시 넘어서? 사람은 못 봤는데, 불빛이 뭔가 찾는 것처럼 이리저리 움직였던 것 같아.' 중요한 단서를 얻었다.",
                imagePrompt: "An anime-style illustration of two students talking seriously in a classroom. One is listening intently, processing the new information.",
                choices: [
                    { text: "고맙다고 하고 과학실로 향한다.", nextScene: 'go_to_lab' },
                    { text: "선생님께 이 사실을 말씀드린다.", nextScene: 'talk_to_teacher' },
                ]
            },
            'check_window_from_inside': {
                text: "나는 창문 쪽으로 다가갔다. 창문은 확실히 안에서 잠그는 장치가 풀려 있었다. 밖에서 억지로 연 흔적은 보이지 않았다. 누군가 안에서 열고 나갔거나, 나갈 준비를 해둔 것일까? 창틀에는 희미한 흙먼지 자국이 남아 있었다.",
                imagePrompt: "An anime-style illustration looking at a slightly open window from inside a dark room. There are faint dusty footprints on the windowsill.",
                choices: [
                    { text: "흙먼지 자국에 대해 더 자세히 조사한다.", nextScene: 'investigate_footprints', requires: "관찰력이 뛰어난 학생", clue: "과학실 창틀에서 흙먼지 자국을 발견했다." },
                    { text: "이제 바닥에 떨어진 물건을 확인한다.", nextScene: 'find_clue_in_lab' },
                ]
            },
            'investigate_footprints': {
                text: "나는 '관찰력이 뛰어난' 내 특징을 살려 흙먼지 자국을 자세히 살폈다. 발자국은 아니었지만, 무언가 크고 무거운 것을 끌었던 자국처럼 보였다. 자국은 창문에서부터 '철수'가 있던 받침대까지 이어져 있었다.",
                imagePrompt: "A close-up anime-style illustration of faint drag marks on a dusty floor, leading from a window to an empty stand.",
                choices: [
                    { text: "이제 바닥에 떨어진 물건을 확인한다.", nextScene: 'find_clue_in_lab' },
                ]
            },
            'search_more_in_lab': {
                text: "나는 단추를 주머니에 넣고 과학실을 더 둘러보았다. 약품 찬장, 실험 도구들... 모든 것이 제자리에 있는 듯했다. 하지만 '철수'가 있던 받침대 뒤편에서 접힌 쪽지 하나를 발견했다.",
                imagePrompt: "An anime-style illustration of a hand discovering a small, folded note behind a stand in a science lab.",
                choices: [
                    { text: "쪽지를 펼쳐본다.", nextScene: 'read_note', clue: "받침대 뒤에서 의문의 쪽지를 발견했다." },
                    { text: "밖으로 나가 단추에 대해 물어본다.", nextScene: 'ask_about_button', requires: "친구가 많은 학생" },
                ]
            },
            'read_note': {
                text: "나는 쪽지를 조심스럽게 펼쳤다. 안에는 이상한 암호 같은 글이 적혀 있었다. '달이 가장 높이 뜰 때, 거울의 방에서 새로운 몸을 얻으리라.' 거울의 방? 학교에 그런 곳이 있었던가?",
                imagePrompt: "A close-up anime-style illustration of a hand holding an old note with mysterious, cryptic text written on it.",
                choices: [
                    { text: "'거울의 방'에 대해 조사한다.", nextScene: 'ask_about_button', clue: "쪽지에는 '거울의 방'이라는 장소가 언급되어 있다." },
                    { text: "밖으로 나가 단추에 대해 물어본다.", nextScene: 'ask_about_button', requires: "친구가 많은 학생" },
                ]
            },
            'ask_about_button': {
                text: "나는 교실로 돌아와 '친구가 많은' 내 특기를 살려 아이들에게 은색 단추를 보여주며 물어보았다. 대부분은 처음 보는 단추라고 했다. 하지만 발이 넓은 '수진'이가 단추를 보더니 말했다. '어? 이거 우리 학교 연극부 소품실에서 본 단추랑 비슷한데? 작년 축제 때 썼던 왕자님 의상에 달린 거 말이야.'",
                imagePrompt: "An anime-style illustration of a student showing a silver button to a group of friends. One girl looks surprised with a flash of recognition.",
                choices: [
                    { text: "연극부실로 가본다.", nextScene: 'go_to_theater_club', clue: "은색 단추는 연극부 소품일 가능성이 높다." },
                    { text: "수진이에게 더 자세한 것을 묻는다.", nextScene: 'ask_sujin_more' },
                ]
            },
            'ask_sujin_more': {
                text: "나는 수진이에게 더 물었다. '그 의상, 지금도 연극부실에 있을까?' 수진이는 고개를 끄덕였다. '응, 아마 소품 창고에 그대로 있을 거야. 연극부 부장인 '김선배'라면 잘 알 텐데. 지금쯤 부실에 있을지도 몰라.'",
                imagePrompt: "An anime-style illustration of two female students talking. One is giving detailed information while pointing towards a direction, possibly the theater club room.",
                choices: [
                    { text: "연극부실로 가본다.", nextScene: 'go_to_theater_club' },
                ]
            },
            'go_to_theater_club': {
                text: "나는 곧장 강당 옆에 있는 연극부실로 향했다. 다행히 문이 열려 있었다. 안은 어두컴컴했고, 각종 연극 소품과 의상들이 어지럽게 널려 있었다. 한쪽 구석에 있는 마네킹이 왠지 '철수'와 닮아 보였다.",
                imagePrompt: "An anime-style illustration of the inside of a dark and cluttered school theater club room. Props and costumes are everywhere. In the corner, a mannequin stands ominously.",
                choices: [
                    { text: "마네킹에게 다가가 확인한다.", nextScene: 'check_mannequin' },
                    { text: "소품실을 먼저 뒤져본다.", nextScene: 'search_prop_room' },
                ]
            },
            'check_mannequin': {
                text: "마네킹에게 다가가자, 나는 확신했다. 이것은 '철수'였다! 누군가 '철수'를 이곳으로 옮겨와 왕자님 의상을 입혀 놓은 것이다. 의상의 단추 하나가 떨어져 나가 있었다. 그때, 뒤에서 인기척이 들렸다.",
                imagePrompt: "An anime-style illustration of a student standing in front of a human anatomy model ('Cheol-su') dressed in a prince costume inside a theater club room. The model is missing a button.",
                choices: [
                    { text: "뒤를 돌아본다.", nextScene: 'confront_culprit' },
                ]
            },
            'confront_culprit': {
                text: "뒤를 돌아보니, 그곳에는 연극부 부장인 김선배가 서 있었다. 그는 멋쩍게 웃으며 말했다. '아... 들켰네. 다음 연극 주인공으로 '철수'를 캐스팅하고 싶었어. 너무 완벽한 배우라서... 선생님께는 나중에 말씀드리려고 했는데...' 사건은 이렇게 허무하게 해결되었다.",
                imagePrompt: "An anime-style illustration of a high school senior scratching his head sheepishly in a theater club room. In front of him, a younger student stands next to the costumed anatomy model.",
                choices: [
                    { text: "사건 해결! (새 게임 시작하기)", action: 'reset' },
                ]
            },
             'search_prop_room': {
                text: "나는 마네킹 대신 소품실을 먼저 뒤져보기로 했다. 먼지 쌓인 상자들과 낡은 의상들 사이를 헤치며 살펴보았지만, '철수'와 관련된 단서는 찾을 수 없었다. 역시 마네킹이 수상하다.",
                imagePrompt: "An anime-style illustration of a student searching through a messy prop room, with dusty boxes and old costumes. The student looks frustrated.",
                choices: [
                    { text: "마네킹에게 다가가 확인한다.", nextScene: 'check_mannequin' },
                ]
            },
        };

        // 이미지 생성 함수 (Gemini API 호출)
        async function generateImage(prompt) {
            imageDisplay.innerHTML = `<div class="loader"></div>`; // 로딩 스피너 표시

            // 이 부분은 실제 API 호출 로직입니다.
            // Canvas 환경에서는 API 키가 자동으로 관리됩니다.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
            const payload = {
                instances: [{ "prompt": prompt }],
                parameters: { "sampleCount": 1 }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    imageDisplay.innerHTML = `<img src="${imageUrl}" alt="장면 이미지" class="w-full h-full object-cover rounded-lg">`;
                } else {
                    throw new Error('Invalid response structure from API.');
                }
            } catch (error) {
                console.error("Image generation error:", error);
                imageDisplay.innerHTML = `<p class="text-red-500">이미지 생성에 실패했습니다. 잠시 후 다시 시도해주세요.</p>`;
            }
        }
        
        // 게임 리셋 함수
        function resetGame() {
            gameContainer.classList.add('hidden');
            characterModal.classList.remove('hidden');

            document.getElementById('character-name').value = '';
            document.getElementById('character-trait').selectedIndex = 0;

            gameState = {
                character: { name: '', trait: '' },
                currentScene: 'start',
                notes: [],
            };
            
            updateMysteryNote();
            storyText.textContent = '';
            imageDisplay.innerHTML = '<p class="text-gray-500">장면 이미지가 여기에 표시됩니다.</p>';
            choicesContainer.innerHTML = '';
            playerInfo.textContent = '';
        }

        // 장면 렌더링 함수
        function renderScene(sceneId) {
            const scene = storyData[sceneId];
            if (!scene) {
                console.error(`Scene with id "${sceneId}" not found!`);
                storyText.textContent = `오류: "${sceneId}" 장면을 찾을 수 없습니다. 개발자에게 문의해주세요.`;
                choicesContainer.innerHTML = '';
                return;
            }

            gameState.currentScene = sceneId;
            storyText.textContent = scene.text;
            
            if (scene.imagePrompt) {
                generateImage(scene.imagePrompt);
            } else {
                imageDisplay.innerHTML = `<p class="text-gray-500">이 장면에는 이미지가 없습니다.</p>`;
            }

            choicesContainer.innerHTML = '';
            scene.choices.forEach(choice => {
                const requiresTrait = choice.requires;
                const canChoose = !requiresTrait || gameState.character.trait === requiresTrait;

                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = `w-full text-left p-3 rounded-md transition duration-300 ${canChoose ? 'bg-gray-700 hover:bg-blue-600' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`;
                
                if (canChoose) {
                    button.onclick = () => handleChoice(choice);
                } else {
                    button.title = `이 선택지는 '${requiresTrait}' 특징이 필요합니다.`;
                    button.disabled = true;
                }
                choicesContainer.appendChild(button);
            });
        }
        
        // 선택지 처리 함수
        function handleChoice(choice) {
            if (choice.action === 'reset') {
                resetGame();
                return;
            }

            if (choice.clue) {
                if (!gameState.notes.includes(choice.clue)) {
                    gameState.notes.push(choice.clue);
                    updateMysteryNote();
                }
            }
            renderScene(choice.nextScene);
        }

        // 미스터리 노트 업데이트 함수
        function updateMysteryNote() {
            if (gameState.notes.length === 0) {
                mysteryNote.innerHTML = '<li>아직 발견된 단서가 없습니다.</li>';
            } else {
                mysteryNote.innerHTML = gameState.notes.map(note => `<li>${note}</li>`).join('');
            }
        }

        // 게임 시작 함수
        function startGame() {
            characterModal.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            playerInfo.textContent = `${gameState.character.name} (${gameState.character.trait})`;
            renderScene('start');
        }

        // 캐릭터 생성 폼 제출 이벤트
        characterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('character-name');
            const traitSelect = document.getElementById('character-trait');
            
            if (nameInput.value.trim() === '') {
                alert('탐정의 이름을 입력해주세요.');
                return;
            }

            gameState.character.name = nameInput.value.trim();
            gameState.character.trait = traitSelect.value;
            
            startGame();
        });

    </script>
</body>
</html>
