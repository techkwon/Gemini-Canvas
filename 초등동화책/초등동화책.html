<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš”ìˆ ë¨í”„ ë™í™” ë§Œë“¤ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Gowun Dodum', 'Inter', sans-serif;
            background-color: #FFF0F5; /* Light LavendarBlush */
            overflow-x: hidden; 
            position: relative; 
            /* Custom heart cursor for the body */
            cursor: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 16 16\' fill=\'%23FFC0CB\'%3e%3cpath d=\'M8 13.12L6.89 12.08C3.59 9.27 1.33 7.33 1.33 5C1.33 3.08 2.92 1.5 4.83 1.5C5.83 1.5 6.79 1.92 7.44 2.59L8 3.17l.56-.58C9.21 1.92 10.17 1.5 11.17 1.5C13.08 1.5 14.67 3.08 14.67 5C14.67 7.33 12.41 9.27 9.11 12.08L8 13.12z\'/%3e%3c/svg%3e') 8 13, auto;
        }
        h1, h2, h3, label, button, #customAlertTitle {
            font-family: 'Gaegu', 'Inter', cursive;
            font-weight: 700;
        }
        h1 { font-size: 3rem; line-height: 1.2; color: #EC4899; /* Pink-500 */ }
        h2 { color: #8B5CF6; /* Violet-500 */ }
        label { color: #7C3AED; /* Violet-600 */ }

        /* Button base styles for transition */
        .action-button, #customAlertCloseButton {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease-out;
            will-change: transform, box-shadow; /* Optimize for transform and shadow animations */
            cursor: pointer; /* Ensure all buttons show pointer cursor */
        }

        /* Common hover effects for main action buttons */
        .action-button:hover {
            transform: scale(1.05) translateY(-2px); /* Lift and scale */
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); /* Enhanced shadow */
        }
        
        /* Specific hover for modal close button */
        #customAlertCloseButton:hover {
            background-color: #9333EA; /* Purple-600 - specific color */
            transform: scale(1.08) translateY(-1px); /* Slightly different pop */
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }


        button#generateButton { 
            background-color: #FBBF24; /* Amber-400 */ 
        }
        button#generateButton:hover { 
            background-color: #F59E0B; /* Amber-500 */
        }
        button#readStoryButton { 
            background-color: #22D3EE; /* Cyan-400 */ 
        }
        button#readStoryButton:hover { 
            background-color: #06B6D4; /* Cyan-500 */ 
        }
        button#readStoryButton.reading { 
            background-color: #F472B6; /* Pink-400 */ 
        }
        button#readStoryButton.reading:hover { 
            background-color: #EC4899; /* Pink-500 */ 
        }
        
        #storyPrompt::placeholder {
            font-family: 'Gowun Dodum', sans-serif;
            color: #A78BFA; /* Violet-400 */
        }
        #storyText {
            font-family: 'Gowun Dodum', sans-serif;
            line-height: 1.8;
            color: #374151; /* Gray-700 */
        }
        .cute-container {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative; 
            z-index: 10;
        }
        .spinner {
            border-top-color: #EC4899; /* Pink-500 */
            border-right-color: transparent;
            border-bottom-color: #EC4899; /* Pink-500 */
            border-left-color: transparent;
        }
        #customAlertModal .modal-content {
             background-color: #FFE4E1; /* MistyRose */
             border-radius: 20px;
             padding: 25px;
             border: 3px dashed #F472B6; /* Pink-400 */
        }
        #customAlertModal #customAlertTitle { color: #D946EF; /* Fuchsia-500 */ }
        #customAlertModal #customAlertMessage { color: #6B21A8; /* Purple-800 */ font-family: 'Gowun Dodum', sans-serif; white-space: pre-wrap; word-break: break-all;}
        #customAlertModal #customAlertCloseButton {
            background-color: #A855F7; /* Purple-500 */
            color: white;
            font-family: 'Gaegu', cursive;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 12px;
            /* transition and will-change are now handled by the common rule */
        }
        #storyImage {
            cursor: pointer; /* Standard pointer for clickable image */
        }

        /* Background Hearts Animation */
        .hearts-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 0; 
            overflow: hidden;
        }

        .heart {
            position: absolute;
            width: 20px;
            height: 20px;
            opacity: 0;
            animation: heart-rise 8s infinite ease-in;
            /* The actual heart shape is drawn using ::before and ::after pseudo-elements */
        }

        .heart::before,
        .heart::after {
            content: '';
            position: absolute;
            top: 0;
            width: 10px; /* Half of the .heart width */
            height: 16px; 
            background-color: var(--heart-color, #FFC0CB); /* Default pink, can be overridden */
            border-radius: 10px 10px 0 0;
        }

        .heart::before {
            left: 10px; /* Position the right half */
            transform: rotate(-45deg);
            transform-origin: 0 100%;
        }

        .heart::after {
            left: 0; /* Position the left half */
            transform: rotate(45deg);
            transform-origin: 100% 100%;
        }

        @keyframes heart-rise {
            0% {
                bottom: -20px; 
                opacity: 0;
            }
            10% {
                opacity: 0.7; 
            }
            90% {
                opacity: 0.7; 
            }
            100% {
                bottom: 100%; 
                opacity: 0; 
                transform: translateX(var(--tx, 0px)) scale(var(--scale, 1));
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="hearts-container" id="heartsContainer"></div>

    <div class="container mx-auto max-w-2xl">
        <header class="text-center py-6 md:py-8">
            <h1 class="text-4xl md:text-5xl font-bold">ğŸ¨ ìš”ìˆ ë¨í”„ ë™í™” ë¨í”„ ğŸ§</h1>
            <p class="text-lg text-pink-500 mt-2" style="font-family: 'Gaegu', cursive; font-weight:700;">ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ê³  ë“¤ì–´ë³¼ê¹Œìš”?</p>
        </header>

        <main>
            <div class="prompt-section cute-container">
                <label for="storyPrompt" class="block text-2xl font-semibold mb-3 text-center">ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ê³  ì‹¶ë‚˜ìš”? (í•œêµ­ì–´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”)</label>
                <textarea id="storyPrompt" class="w-full p-4 border-2 border-purple-300 rounded-xl focus:ring-purple-500 focus:border-purple-500 text-lg" rows="3" placeholder="ì˜ˆ) ìš©ê°í•œ ì•„ê¸°í† ë¼ì˜ ìš°ì£¼ ëª¨í—˜"></textarea>
                <button id="generateButton" class="action-button mt-5 w-full text-white font-bold py-4 px-6 rounded-xl text-2xl shadow-md">
                    ì´ì•¼ê¸° ëšë”±! âœ¨
                </button>
            </div>

            <div id="loadingIndicator" class="text-center my-8 hidden">
                <div class="inline-block animate-spin spinner rounded-full h-16 w-16 border-8"></div>
                <p class="text-pink-600 text-xl mt-4" style="font-family: 'Gaegu', cursive; font-weight:700;">ì´ì•¼ê¸°ì™€ ê·¸ë¦¼ì„ ë§Œë“¤ê³  ìˆì–´ìš”... <br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! ì–! ğŸª„</p>
            </div>

            <div id="storyOutput" class="hidden">
                <div class="image-display cute-container">
                    <h2 class="text-3xl font-semibold mb-5 text-center">ì§ ! ë©‹ì§„ ê·¸ë¦¼ì´ì—ìš”!</h2>
                    <img id="storyImage" src="https://placehold.co/600x400/E0F2F7/333333?text=ê·¸ë¦¼ì´+ë‚˜ì˜¬+ê³³ì´ì—ìš”!+%E2%9C%A8&font=gaegu" alt="ìƒì„±ëœ ë™í™” ì´ë¯¸ì§€" class="w-full max-w-md mx-auto rounded-lg shadow-md border-4 border-pink-300">
                    <div id="imageError" class="text-red-500 text-center mt-3 text-lg hidden" style="font-family: 'Gowun Dodum', sans-serif;"></div>
                </div>

                <div class="text-display cute-container mt-8">
                    <h2 class="text-3xl font-semibold mb-5 text-center">ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ê°€ í¼ì³ì§‘ë‹ˆë‹¤!</h2>
                    <div id="storyText" class="text-lg leading-relaxed whitespace-pre-wrap p-2">
                        ì—¬ê¸°ì— ì´ì•¼ê¸°ê°€ ë‚˜ì˜¬ ê±°ì˜ˆìš”. ë‘ê·¼ë‘ê·¼! ğŸ’–
                    </div>
                    <div id="textError" class="text-red-500 text-center mt-3 text-lg hidden" style="font-family: 'Gowun Dodum', sans-serif;"></div>
                    <button id="readStoryButton" class="action-button mt-5 w-full text-white font-bold py-3 px-5 rounded-lg text-xl shadow-md hidden">
                        ë™í™” ì½ì–´ì£¼ê¸° ğŸ“¢
                    </button>
                </div>
            </div>
        </main>

        <footer class="text-center py-8 mt-10">
            <p class="text-md text-pink-500" style="font-family: 'Gowun Dodum', sans-serif;">Â© 2025 ì‹ ë‚˜ëŠ” ë™í™” ì„¸ìƒ</p>
        </footer>
    </div>

    <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-40 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="modal-content w-full max-w-md mx-auto">
            <div class="text-center">
                <h3 id="customAlertTitle" class="text-3xl font-bold">ì•Œë¦¼!</h3>
                <p id="customAlertMessage" class="text-lg mt-4 mb-6">ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                <button id="customAlertCloseButton" class="text-xl">í™•ì¸</button> 
                </div>
        </div>
    </div>

    <script>
        const storyPromptInput = document.getElementById('storyPrompt');
        const generateButton = document.getElementById('generateButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const storyOutput = document.getElementById('storyOutput');
        const storyImage = document.getElementById('storyImage');
        const storyText = document.getElementById('storyText');
        const imageError = document.getElementById('imageError');
        const textError = document.getElementById('textError');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseButton = document.getElementById('customAlertCloseButton');
        const readStoryButton = document.getElementById('readStoryButton');
        const heartsContainer = document.getElementById('heartsContainer');


        const defaultImageUrl = 'https://placehold.co/600x400/E0F2F7/333333?text=ê·¸ë¦¼ì´+ë‚˜ì˜¬+ê³³ì´ì—ìš”!+%E2%9C%A8&font=gaegu';
        const defaultStoryText = 'ì—¬ê¸°ì— ì´ì•¼ê¸°ê°€ ë‚˜ì˜¬ ê±°ì˜ˆìš”. ë‘ê·¼ë‘ê·¼! ğŸ’–';
        
        let originalKoreanPromptForImage = ''; 
        let fullEnglishImageGenPrompt = ''; 
        let currentUtterance = null; 

        const GEMINI_API_KEY = ""; 
        const GEMINI_TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${GEMINI_API_KEY}`;
        const DESCRIPTIVE_STYLE_FOR_IMAGE_EN = "Very cute and lovely characters. Bright, warm, and colorful. Happy and fantastical atmosphere. Clear and soft drawing style. Include background.";


        generateButton.addEventListener('click', generateStoryAndImage);
        customAlertCloseButton.addEventListener('click', () => customAlertModal.classList.add('hidden'));
        storyImage.addEventListener('click', showImagePromptInfo);
        readStoryButton.addEventListener('click', toggleReadStory);


        function showCustomAlert(message, title = "ì•—!") {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        }

        function showImagePromptInfo() {
            if (fullEnglishImageGenPrompt && originalKoreanPromptForImage) {
                const message = `ğŸ¨ ì´ ê·¸ë¦¼ì€ ì´ë ‡ê²Œ ë§Œë“¤ì–´ì¡Œì–´ìš” ğŸ¨\n\n--- ì‚¬ìš©ì ì…ë ¥ (í•œêµ­ì–´) ---\n"${originalKoreanPromptForImage}"\n\n--- ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ (ì˜ì–´) ---\n"${fullEnglishImageGenPrompt}"`;
                showCustomAlert(message, "ê·¸ë¦¼ í”„ë¡¬í”„íŠ¸ ì •ë³´");
            } else {
                showCustomAlert("ì•„ì§ ê·¸ë¦¼ì´ ë§Œë“¤ì–´ì§€ì§€ ì•Šì•˜ê±°ë‚˜, í”„ë¡¬í”„íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”. ğŸ˜¥", "ê·¸ë¦¼ í”„ë¡¬í”„íŠ¸ ì •ë³´");
            }
        }

        function toggleReadStory() {
            if (!storyText.textContent || storyText.textContent === defaultStoryText) {
                showCustomAlert("ë¨¼ì € ë™í™”ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”! ğŸ˜Š");
                return;
            }

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel(); 
                readStoryButton.textContent = "ë™í™” ì½ì–´ì£¼ê¸° ğŸ“¢";
                readStoryButton.classList.remove('reading');
                if (currentUtterance) {
                    currentUtterance.onend = null; 
                    currentUtterance.onstart = null;
                    currentUtterance.onerror = null;
                }
                currentUtterance = null;
            } else {
                currentUtterance = new SpeechSynthesisUtterance(storyText.textContent);
                currentUtterance.lang = 'ko-KR'; 
                currentUtterance.rate = 0.9; 
                currentUtterance.pitch = 1.1;

                currentUtterance.onstart = () => {
                    readStoryButton.textContent = "ì½ëŠ” ì¤‘... ë©ˆì¶”ë ¤ë©´ í´ë¦­! ğŸ¤«";
                    readStoryButton.classList.add('reading');
                };
                currentUtterance.onend = () => {
                    readStoryButton.textContent = "ë™í™” ì½ì–´ì£¼ê¸° ğŸ“¢";
                    readStoryButton.classList.remove('reading');
                    if (currentUtterance) { 
                         currentUtterance.onstart = null;
                         currentUtterance.onerror = null;
                         currentUtterance.onend = null; 
                    }
                    currentUtterance = null;
                };
                currentUtterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror event object:', event);
                    let detailedErrorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ìŒì„± ì¬ìƒ ì˜¤ë¥˜';
                    if (event.error) {
                        if (typeof event.error === 'string') {
                            detailedErrorMessage = `ìŒì„± ì˜¤ë¥˜ ì½”ë“œ: ${event.error}`;
                            switch (event.error) {
                                case 'canceled': detailedErrorMessage = 'ìŒì„± ì¬ìƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'; break;
                                case 'interrupted': detailedErrorMessage = 'ìŒì„± ì¬ìƒì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'; break;
                                case 'audio-busy': detailedErrorMessage = 'ìŒì„± ì¥ì¹˜ê°€ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'; break;
                                case 'audio-hardware': detailedErrorMessage = 'ìŒì„± ì¥ì¹˜ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'; break;
                                case 'network': detailedErrorMessage = 'ìŒì„± í•©ì„±ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; break;
                                case 'synthesis-unavailable': detailedErrorMessage = 'ìŒì„± í•©ì„± ì—”ì§„ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; break;
                                case 'synthesis-failed': detailedErrorMessage = 'ìŒì„± í•©ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; break;
                                case 'language-unavailable': detailedErrorMessage = 'ì„ íƒëœ ì–¸ì–´(í•œêµ­ì–´)ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; break;
                                case 'voice-unavailable': detailedErrorMessage = 'ì„ íƒëœ ìŒì„±ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; break;
                                case 'text-too-long': detailedErrorMessage = 'ì½ì„ ë‚´ìš©ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤.'; break;
                                case 'invalid-argument': detailedErrorMessage = 'ìŒì„± í•©ì„±ì— ì˜ëª»ëœ ì¸ìê°€ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.'; break;
                                case 'not-allowed': detailedErrorMessage = 'ìŒì„± ì¬ìƒ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'; break;
                                default: detailedErrorMessage = `ì•Œë ¤ì§€ì§€ ì•Šì€ ìŒì„± ì˜¤ë¥˜ ì½”ë“œ: ${event.error}`; break;
                            }
                        } else {
                            console.warn('SpeechSynthesisUtterance.onerror: event.error was not a string. Value:', event.error, 'Type:', typeof event.error);
                            detailedErrorMessage = 'ìŒì„± ì¬ìƒ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (ì˜¤ë¥˜ íƒ€ì… í™•ì¸ í•„ìš”).';
                            try {
                                const errorDetails = JSON.stringify(event.error);
                                if (errorDetails !== '{}' && event.error.toString() !== '[object Object]') { 
                                    detailedErrorMessage += ` (ì„¸ë¶€ ì •ë³´: ${errorDetails})`;
                                } else if (event.error && typeof event.error.isTrusted !== 'undefined') { 
                                     detailedErrorMessage += ` (ë¸Œë¼ìš°ì € ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ)`;
                                }
                            } catch (e) { /* ignore stringify error */ }
                        }
                    }
                    showCustomAlert(`ë™í™”ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ${detailedErrorMessage}`, "ìŒì„± ì¬ìƒ ì˜¤ë¥˜");
                    readStoryButton.textContent = "ë™í™” ì½ì–´ì£¼ê¸° ğŸ“¢";
                    readStoryButton.classList.remove('reading');
                    if (currentUtterance) {
                         currentUtterance.onstart = null;
                         currentUtterance.onend = null;
                         currentUtterance.onerror = null; 
                    }
                    currentUtterance = null;
                };
                speechSynthesis.speak(currentUtterance);
            }
        }
        

        async function callGeminiAPI(promptText) { 
            const payload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }]
            };
            
            const response = await fetch(GEMINI_TEXT_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            
            if (!response.ok) {
                let errorMessage = `Gemini API ì˜¤ë¥˜ (ìƒíƒœ: ${response.status})`;
                let errorDetail = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'; 
                let serverErrorObject = null; 

                try {
                    serverErrorObject = await response.json();
                    errorDetail = serverErrorObject.error?.message || response.statusText || 'ì˜¤ë¥˜ ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ';
                    if (serverErrorObject.error?.details) {
                         console.warn("Gemini API Error Details from server:", serverErrorObject.error.details);
                    }
                } catch (e) {
                    errorDetail = response.statusText || 'ì˜¤ë¥˜ ì‘ë‹µ ë³¸ë¬¸ íŒŒì‹± ë¶ˆê°€';
                }
                
                if (response.status === 401) {
                    console.error("Gemini API 401 (Authentication/Authorization Error).", 
                        "Prompt (first 50 chars):", promptText.substring(0,50), 
                        "Server Response Status:", response.status, 
                        "Server Error Detail:", errorDetail,
                        "Parsed Server Error Object:", serverErrorObject 
                    );
                    errorMessage = `Gemini API ì¸ì¦ ì‹¤íŒ¨ (ìƒíƒœ: 401): í˜„ì¬ ì•±ì— ì œê³µëœ API í‚¤ë¡œëŠ” ìš”ì²­í•˜ì‹  ì‘ì—…ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. API í‚¤ì™€ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì„œë²„ ì„¸ë¶€ ì •ë³´: ${errorDetail})`;
                } else {
                    errorMessage += `: ${errorDetail}`;
                }
                console.error("Full Gemini API Error to be thrown:", errorMessage);
                throw new Error(errorMessage);
            }

            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts) {
                let accumulatedText = "";
                for (const part of result.candidates[0].content.parts) {
                    if (part.text) {
                        accumulatedText += part.text;
                    }
                }
                if (accumulatedText) {
                    return accumulatedText;
                }
            }
            console.error("Gemini API - Unexpected response structure:", result);
            throw new Error('Gemini APIë¡œë¶€í„° ìœ íš¨í•œ í…ìŠ¤íŠ¸ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (ì‘ë‹µ êµ¬ì¡° í™•ì¸ í•„ìš”).');
        }


        async function generateStoryAndImage() {
            originalKoreanPromptForImage = storyPromptInput.value.trim(); 
            if (!originalKoreanPromptForImage) {
                showCustomAlert('ì´ì•¼ê¸° ì£¼ì œë¥¼ í•œêµ­ì–´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”! ë¬´ì—‡ì´ë“  ì¢‹ì•„ìš” ğŸ˜Š');
                return;
            }

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                readStoryButton.textContent = "ë™í™” ì½ì–´ì£¼ê¸° ğŸ“¢";
                readStoryButton.classList.remove('reading');
                if (currentUtterance) {
                    currentUtterance.onend = null;
                    currentUtterance.onstart = null;
                    currentUtterance.onerror = null;
                }
                currentUtterance = null;
            }


            loadingIndicator.classList.remove('hidden');
            storyOutput.classList.add('hidden'); 
            readStoryButton.classList.add('hidden'); 
            storyImage.src = defaultImageUrl; 
            storyText.innerHTML = defaultStoryText; 
            imageError.classList.add('hidden'); 
            textError.classList.add('hidden');
            fullEnglishImageGenPrompt = ''; 
            

            let generatedText = '';
            let translatedForImage = '';

            try {
                const storySystemPrompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒì„ ìœ„í•œ ì§§ê³  ì¬ë¯¸ìˆê³  êµí›ˆì ì¸ ë™í™”ë¥¼ ì“°ëŠ” ì‘ê°€ì…ë‹ˆë‹¤. ë‚´ìš©ì€ ì•½ 3~5ë¬¸ë‹¨ìœ¼ë¡œ, ê° ë¬¸ë‹¨ì€ 3-5ë¬¸ì¥ ì •ë„ë¡œ êµ¬ì„±í•´ì£¼ì„¸ìš”. ì¹œì ˆí•˜ê³  ë”°ëœ»í•œ ì–´íˆ¬ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”. ë‹¤ìŒ ì£¼ì œë¡œ ë™í™”ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”: "${originalKoreanPromptForImage}"`;
                generatedText = await callGeminiAPI(storySystemPrompt);
                storyText.textContent = generatedText; 
                if (generatedText && generatedText !== defaultStoryText) {
                    readStoryButton.classList.remove('hidden'); 
                }
            } catch (error) {
                console.error('Error generating story text:', error);
                textError.textContent = `ì´ì•¼ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜: ${error.message}`;
                textError.classList.remove('hidden'); storyText.innerHTML = 'ì´ì•¼ê¸°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”. ğŸ˜¥';
            }

            try {
                const translatePrompt = `ë‹¤ìŒ í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ë¡œ ë²ˆì—­í•´ì£¼ì„¸ìš”: "${originalKoreanPromptForImage}"`;
                translatedForImage = await callGeminiAPI(translatePrompt);
                fullEnglishImageGenPrompt = `Children's storybook illustration style. Illustrate the following: "${translatedForImage}". ${DESCRIPTIVE_STYLE_FOR_IMAGE_EN}`; 
                
                const imagePayload = { instances: [{ prompt: fullEnglishImageGenPrompt }], parameters: { "sampleCount": 1 } };
                const imageResponse = await fetch(IMAGEN_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(imagePayload) });
                
                if (!imageResponse.ok) {
                    let errorMessage = `ì´ë¯¸ì§€ ìƒì„± ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (ìƒíƒœ: ${imageResponse.status})`;
                    try { const errorData = await imageResponse.json(); errorMessage = `ì´ë¯¸ì§€ API ì˜¤ë¥˜: ${errorData.error?.message || imageResponse.statusText} (ìƒíƒœ: ${imageResponse.status})`; }
                    catch (e) { errorMessage += `: ${imageResponse.statusText || 'ì‘ë‹µ ë³¸ë¬¸ íŒŒì‹± ë¶ˆê°€'}`; }
                    console.error("Image API Error:", errorMessage); throw new Error(errorMessage);
                }
                const imageResult = await imageResponse.json();
                if (imageResult.predictions?.[0]?.bytesBase64Encoded) {
                    storyImage.src = `data:image/png;base64,${imageResult.predictions[0].bytesBase64Encoded}`;
                } else {
                    throw new Error('ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆê±°ë‚˜ API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) { 
                console.error('Error in image generation process:', error);
                imageError.textContent = `ê·¸ë¦¼ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì œ'}`;
                imageError.classList.remove('hidden'); storyImage.src = defaultImageUrl; 
                fullEnglishImageGenPrompt = ''; originalKoreanPromptForImage = ''; 
            }

            loadingIndicator.classList.add('hidden');
            storyOutput.classList.remove('hidden');
        }

        storyImage.onerror = function() {
            if (this.src !== defaultImageUrl) { 
                 this.src = defaultImageUrl;
                 imageError.textContent = 'ê·¸ë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ê¸°ë³¸ ê·¸ë¦¼ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.';
                 imageError.classList.remove('hidden');
                 fullEnglishImageGenPrompt = ''; originalKoreanPromptForImage = '';
            }
        };

        window.addEventListener('beforeunload', () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
        });

        // Function to create and animate hearts
        function createHearts() {
            const numberOfHearts = 15; 
            for (let i = 0; i < numberOfHearts; i++) {
                const heart = document.createElement('div');
                heart.classList.add('heart');
                heart.style.left = `${Math.random() * 100}vw`; 
                heart.style.animationDelay = `${Math.random() * 7}s`; 
                heart.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`); 
                heart.style.setProperty('--scale', `${0.5 + Math.random() * 0.8}`); 
                // To apply random colors to ::before and ::after, you'd typically set a CSS variable on the .heart element
                // and then use that variable in the ::before/::after rules.
                // However, background-color on .heart itself won't color the pseudo-elements.
                // For simplicity, we'll use the default pink defined in the CSS for ::before/::after.
                // If truly random colors for each heart's pseudo-elements are needed, it would require
                // dynamically creating <style> tags or more complex CSS variable handling.
                heartsContainer.appendChild(heart);
            }
        }
        createHearts(); 

    </script>
</body>
</html>
